<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>US号码管家 - 动漫风格</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Nunito', 'Arial Rounded MT Bold', '微软雅黑', sans-serif;
    }
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #aee2ff 0%, #f6d6ff 100%);
      padding: 20px;
      color: #1f2937;
      line-height: 1.5;
      position: relative;
      overflow-x: hidden;
    }
    .page {
      display: none;
    }
    .page.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* 卡片与容器 */
    .card {
      background: linear-gradient(120deg, #fff7fa 0%, #e3f6ff 100%);
      border-radius: 24px;
      box-shadow: 0 6px 24px rgba(160, 226, 255, 0.15), 0 1.5px 6px rgba(246, 214, 255, 0.12);
      padding: 24px;
      margin-bottom: 24px;
      transition: box-shadow 0.3s, transform 0.2s;
      animation: cardPop 0.5s cubic-bezier(.68,-0.55,.27,1.55);
    }
    @keyframes cardPop {
      0% { transform: scale(0.96); box-shadow: 0 0 0 rgba(0,0,0,0); }
      80% { transform: scale(1.04); }
      100% { transform: scale(1); }
    }
    .card:hover {
      box-shadow: 0 12px 32px rgba(160, 226, 255, 0.22), 0 3px 12px rgba(246, 214, 255, 0.18);
      transform: translateY(-2px) scale(1.02);
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .section-title {
      font-size: 16px;
      margin-bottom: 15px;
      color: #303133;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* 按钮样式 */
    .btn {
      padding: 10px 20px;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s, box-shadow 0.3s;
      font-weight: 700;
      background: linear-gradient(90deg, #aee2ff 0%, #f6d6ff 100%);
      box-shadow: 0 2px 8px rgba(160, 226, 255, 0.12);
    }
    .btn:active {
      transform: scale(0.96);
    }
    .btn:hover {
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 6px 18px rgba(160, 226, 255, 0.18);
    }
    .btn-primary {
  background: linear-gradient(90deg, #7fbcff 0%, #f6d6ff 100%);
  color: #fff;
  box-shadow: 0 2px 8px rgba(127, 188, 255, 0.18);
    }
    .btn-success {
  background: linear-gradient(90deg, #a8ff78 0%, #78ffd6 100%);
  color: #fff;
    }
    .btn-default {
  background: linear-gradient(90deg, #f5f7fa 0%, #e3f6ff 100%);
  color: #606266;
    }
    .btn-danger {
  background: linear-gradient(90deg, #ffb6b9 0%, #f6d6ff 100%);
  color: #fff;
    }
    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
    }

    /* 输入框与选择器 */
    .input, .select {
  padding: 10px 16px;
  border-radius: 16px;
  border: 1.5px solid #aee2ff;
  font-size: 16px;
  width: 100%;
  transition: border 0.2s, box-shadow 0.3s;
    }
    .input:focus, .select:focus {
  border-color: #7fbcff;
  outline: none;
  box-shadow: 0 0 0 3px rgba(127, 188, 255, 0.18);
    }
    .input-search {
      flex: 1;
      max-width: 400px;
    }
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    .form-col {
      flex: 1;
    }
    @media (max-width: 992px) {
      .form-row {
        flex-wrap: wrap;
        gap: 10px;
      }
      .form-col {
        flex: 0 0 48%;
      }
    }
    @media (max-width: 768px) {
      .form-col {
        flex: 0 0 100%;
      }
    }

    /* 顶部导航 */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f2f5;
    }
    .logo {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 28px;
  font-weight: bold;
  color: #7fbcff;
    }
    .logo-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #aee2ff 0%, #f6d6ff 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 24px;
  box-shadow: 0 2px 8px rgba(160, 226, 255, 0.18);
    }
    .header-actions {
      display: flex;
      gap: 10px;
    }
    .main-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    /* 筛选区 */
    .filter-bar {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    /* 表格样式 */
    .table {
    /* 表格：使用流式布局并占满容器宽度，允许内容换行以避免不必要的水平滚动 */
    width: 100%;
    background: none;
    padding: 0;
    border-collapse: collapse;
    table-layout: auto; /* 允许列根据内容自动伸缩（比 fixed 更灵活） */
    }
    .table th {
    background-color: #f5f7fa;
    font-weight: 600;
    color: #303133;
    text-align: left;
    padding: 10px 12px;
    }
  .table td {
    padding: 10px 12px;
    vertical-align: middle;
    /* 允许内容换行，避免极长文本导致表格不合理变宽 */
    word-break: break-word;
    white-space: normal;
  }
  /* 表格 UX：固定序号列，给各列设置最小宽度，窄屏时隐藏非关键列 */
    .col-id { position: sticky; left: 0; background: inherit; z-index: 2; min-width: 60px; }
    .col-phone { min-width: 160px; }
    .col-name { min-width: 120px; }
    .col-age { min-width: 70px; }
    .col-assignee { min-width: 140px; }
    .col-importTime { min-width: 140px; }
    .col-fileName { min-width: 140px; }
    .col-actions { min-width: 100px; }

    @media (max-width: 768px) {
      /* 窄屏：隐藏导入文件名和导入时间以节省空间 */
      .col-importTime, .col-fileName { display: none; }
      .table td.col-importTime, .table td.col-fileName { display: none; }
    }
*** End Patch
    .table th:hover {
      background-color: #eef3fa;
    }
    .table tr:hover {
      background-color: #ecf5ff;
    }
    .phone-number {
      font-family: 'Courier New', Courier, monospace;
      color: #303133;
    }
    .table-container {
      overflow-x: auto;
    }

    /* 状态样式 */
    .status-used {
      color: #67c23a;
      font-weight: 500;
    }
    .status-used::before {
      content: "●";
      margin-right: 5px;
      font-size: 16px;
    }
    .status-unused {
      color: #909399;
    }
    .status-unused::before {
      content: "●";
      margin-right: 5px;
      font-size: 16px;
    }

    /* 操作按钮 */
    .oper-btn {
      color: #409eff;
      background: none;
      border: none;
      cursor: pointer;
      margin: 0 5px;
      font-size: 14px;
      padding: 2px 4px;
      border-radius: 4px;
    }
    .oper-btn:hover {
      background-color: #ecf5ff;
    }
    .oper-btn-danger {
      color: #f56c6c;
    }
    .oper-btn-danger:hover {
      background-color: #fef0f0;
    }

    /* 统计信息 */
    .stats {
      margin-bottom: 15px;
      color: #606266;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .stats span {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .stats-used {
      background-color: #f0f9eb;
      color: #67c23a;
    }
    .stats-unused {
      background-color: #f5f7fa;
      color: #909399;
    }

    /* 表单样式 */
    .form {
      max-width: 800px;
      margin: 0 auto;
    }
    .form-item {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #303133;
    }
    .form-hint {
      margin-top: 5px;
      font-size: 12px;
      color: #909399;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 30px;
    }
    .form-note {
      color: #f56c6c;
      font-size: 12px;
      margin-top: 5px;
    }

    /* 时间线样式 */
    .timeline {
      position: relative;
      max-width: 800px;
      margin: 0 auto;
      padding-left: 30px;
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: #e4e7ed;
    }
    .timeline-item {
      position: relative;
      margin-bottom: 30px;
    }
    .timeline-dot {
      position: absolute;
      left: -30px;
      top: 3px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #409eff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 10px;
    }
    .timeline-dot.used {
      background-color: #67c23a;
    }
    .timeline-dot.unused {
      background-color: #909399;
    }
    .timeline-content {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      border: 1px solid #f0f2f5;
    }
    .timeline-time {
      color: #909399;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .timeline-title {
      font-weight: 500;
      margin-bottom: 8px;
    }
    .timeline-detail {
      font-size: 14px;
      color: #606266;
    }

    /* 提示框和加载动画 */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      border-radius: 8px;
      background-color: rgba(0,0,0,0.8);
      color: white;
      font-size: 14px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toast.show {
      opacity: 1;
    }
    .toast-success {
      background-color: rgba(103, 194, 58, 0.9);
    }
    .toast-error {
      background-color: rgba(245, 108, 108, 0.9);
    }
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      z-index: 1001;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 15px;
    }
    .loading.show {
      display: flex;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f0f2f5;
      border-top: 4px solid #409eff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 批量操作模态框 */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .modal-backdrop.show {
      display: flex;
    }
    .modal {
      background-color: white;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid #f0f2f5;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-size: 16px;
      font-weight: 600;
      color: #303133;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #909399;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close:hover {
      background-color: #f5f7fa;
      color: #606266;
    }
    .modal-body {
      padding: 20px;
    }
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #f0f2f5;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* 导入模板和帮助文本 */
    .import-template {
      margin-top: 15px;
      padding: 10px;
      background-color: #f5f7fa;
      border-radius: 8px;
      font-size: 13px;
    }
    .import-template-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: #409eff;
    }
    .import-fields {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .import-field {
      padding: 3px 8px;
      background-color: #ecf5ff;
      border-radius: 4px;
      font-size: 12px;
      color: #409eff;
    }

    /* 人员列表样式 */
    .person-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .person-card {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #f0f2f5;
      transition: all 0.2s;
    }
    .person-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      border-color: #e6f7ff;
    }
    .person-name {
      font-weight: 600;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .person-info {
      font-size: 13px;
      color: #606266;
      margin-bottom: 3px;
    }
    .person-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 5px;
    }

    /* 导入方式选项卡 */
    .import-tabs {
      display: flex;
      border-bottom: 1px solid #e4e7ed;
      margin-bottom: 15px;
    }
    .import-tab {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .import-tab.active {
      border-bottom-color: #409eff;
      color: #409eff;
      font-weight: 500;
    }
    .import-tab-content {
      display: none;
    }
    .import-tab-content.active {
      display: block;
    }

    /* 粘贴导入文本区域 */
    .paste-area {
      width: 100%;
      min-height: 150px;
      padding: 10px;
      border: 1px solid #e4e7ed;
      border-radius: 8px;
      font-family: monospace;
      font-size: 13px;
      resize: vertical;
      margin-bottom: 10px;
    }
    .paste-preview {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e4e7ed;
      border-radius: 8px;
    }
    .paste-preview-header {
      background-color: #f5f7fa;
      font-weight: 500;
    }
    .paste-preview-row {
      display: grid;
      grid-template-columns: 50px 1fr 1fr 1fr 1fr;
      padding: 8px 10px;
      border-bottom: 1px solid #f0f2f5;
      font-size: 13px;
    }
    .paste-preview-row.error {
      background-color: #fff1f0;
    }
    .paste-error {
      color: #f56c6c;
      font-size: 12px;
      margin-top: 5px;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
      .filter-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .input-search {
        width: 100%;
        max-width: none;
      }
      .main-nav {
        flex-wrap: wrap;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      .header-actions {
        width: 100%;
        justify-content: space-between;
      }
      .paste-preview-row {
        grid-template-columns: 40px 1fr;
        grid-template-rows: auto auto auto auto;
        grid-template-areas:
          "index phone"
          "index name"
          "index age"
          "index assignee";
      }
      .paste-preview-row > div:nth-child(1) { grid-area: index; }
      .paste-preview-row > div:nth-child(2) { grid-area: phone; }
      .paste-preview-row > div:nth-child(3) { grid-area: name; }
      .paste-preview-row > div:nth-child(4) { grid-area: age; }
      .paste-preview-row > div:nth-child(5) { grid-area: assignee; }
    }
  </style>
  <script>
    // 早期 polyfill：确保在测试环境（如 jsdom）中有稳定的 confirm 实现，避免 Not implemented 警告
    (function(){
      try {
        if (typeof window !== 'undefined') {
          if (typeof window.confirm !== 'function') {
            window.confirm = function(){ return true; };
          } else {
            // 包装原生 confirm，捕获可能抛出的 Not implemented
            const __orig_confirm = window.confirm;
            window.confirm = function(msg){
              try { return __orig_confirm(msg); } catch(e) { return true; }
            };
          }
        }
      } catch(e){}
    })();

    // 更稳健的 CSV 单行解析：支持双引号包裹、双引号内转义双引号、以及逗号分隔
    function parseCSVLine(line) {
      const result = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && i + 1 < line.length && line[i+1] === '"') {
            // 双引号转义 ""
            cur += '"';
            i++; // skip next quote
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          result.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      result.push(cur);
      return result;
    }
  </script>
</head>
<body>
  <div class="container">
    <!-- 动漫风底部吉祥物 -->
    <div style="position:fixed;bottom:0;right:0;z-index:0;pointer-events:none;">
      <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
        <ellipse cx="60" cy="110" rx="40" ry="10" fill="#aee2ff"/>
        <circle cx="60" cy="70" r="35" fill="#fff7fa" stroke="#aee2ff" stroke-width="3"/>
        <ellipse cx="60" cy="80" rx="18" ry="10" fill="#f6d6ff"/>
        <circle cx="60" cy="65" r="15" fill="#f6d6ff"/>
        <ellipse cx="52" cy="62" rx="3" ry="2" fill="#7fbcff"/>
        <ellipse cx="68" cy="62" rx="3" ry="2" fill="#7fbcff"/>
        <path d="M54 75 Q60 80 66 75" stroke="#7fbcff" stroke-width="2" fill="none"/>
      </svg>
    </div>
    <!-- 提示框组件 -->
    <div class="toast" id="toast"></div>
    
    <!-- 加载动画 -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <div id="loadingText">处理中...</div>
    </div>

    <!-- 批量导入模态框 -->
    <div class="modal-backdrop" id="importModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">批量导入号码</div>
          <button class="modal-close" onclick="closeImportModal()">×</button>
        </div>
        <div class="modal-body">
          <!-- 导入方式选项卡 -->
          <div class="import-tabs">
            <div class="import-tab active" onclick="switchImportTab('file')">文件导入</div>
            <div class="import-tab" onclick="switchImportTab('paste')">粘贴导入</div>
          </div>
          
          <!-- 文件导入内容 -->
          <div class="import-tab-content active" id="fileImportContent">
            <div class="form-item">
              <label class="form-label">选择CSV文件</label>
              <input type="file" class="input" id="importFile" accept=".csv">
              <div class="form-hint">支持格式：.csv，最大1000条数据</div>
            </div>
            
            <div class="form-item">
              <label class="form-label">默认被分配人（可选）</label>
              <select class="select" id="defaultAssignee">
                <option value="">不设置默认值</option>
                <!-- 人员列表将通过JS动态添加 -->
              </select>
              <div class="form-hint">如CSV文件中未指定被分配人，将使用此默认值</div>
            </div>
            
            <div class="import-template">
              <div class="import-template-title">
                文件导入格式说明
              </div>
              <div>支持的字段（顺序必须一致）：</div>
              <div class="import-fields">
                <span class="import-field">phoneNumber（必填）</span>
                <span class="import-field">name（必填）</span>
                <span class="import-field">age（必填）</span>
                <span class="import-field">assignee（可选）</span>
              </div>
              <div>示例：+1-212-555-1234,张三,30,亚马逊团队</div>
              <button class="btn btn-sm btn-default" style="margin-top: 10px;" onclick="downloadImportTemplate()">
                下载模板
              </button>
            </div>
          </div>
          
          <!-- 粘贴导入内容 -->
          <div class="import-tab-content" id="pasteImportContent">
            <div class="form-item">
              <label class="form-label">粘贴数据</label>
              <textarea class="paste-area" id="pasteData" placeholder="请按以下格式粘贴数据，每行一条记录：
美国号码,姓名,年龄,被分配人（可选）
例如：
+1-212-555-1234,张三,30,亚马逊团队
+1-310-555-6789,李四,28
+1-773-555-4321,王五,35,Shopify团队"></textarea>
              <div class="form-hint">每行一条记录，字段用英文逗号分隔，被分配人可省略</div>
              <button class="btn btn-sm btn-primary" onclick="parsePasteData()">
                解析数据
              </button>
            </div>
            
            <!-- 数据预览区域 -->
            <div id="pastePreviewContainer" style="display: none;">
              <div class="form-hint" style="margin-bottom: 10px;">数据预览（共 <span id="previewCount">0</span> 条）</div>
              <div class="paste-preview">
                <div class="paste-preview-header paste-preview-row">
                  <div>序号</div>
                  <div>美国号码</div>
                  <div>姓名</div>
                  <div>年龄</div>
                  <div>被分配人</div>
                </div>
                <div id="pastePreviewContent"></div>
              </div>
              <div id="pasteErrors" class="paste-error"></div>
            </div>
            
            <div class="form-item" style="margin-top: 20px;">
              <label class="form-label">统一分配给（可选）</label>
              <select class="select" id="pasteAssignee">
                <option value="">不分配</option>
                <!-- 人员列表将通过JS动态添加 -->
              </select>
              <div class="form-hint">选择后将覆盖粘贴数据中的被分配人信息</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" onclick="closeImportModal()">取消</button>
          <button class="btn btn-primary" onclick="doImport()">开始导入</button>
        </div>
      </div>
    </div>

    <!-- 批量导出模态框 -->
    <div class="modal-backdrop" id="exportModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">批量导出号码</div>
          <button class="modal-close" onclick="closeExportModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="form-item">
            <label class="form-label">选择导出字段</label>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportPhone"> 美国号码
              </label>
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportName"> 姓名
              </label>
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportAge"> 年龄
              </label>
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportAssignee"> 被分配人
              </label>
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportImportTime"> 导入时间
              </label>
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportFileName"> 导入文件名
              </label>
            </div>
          </div>
          
          <div class="form-item">
            <label class="form-label">导出范围</label>
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <select class="select" id="exportRange" style="flex:1;min-width:220px;">
                <option value="filtered">当前筛选结果</option>
                <option value="all">全部号码</option>
                <option value="random">随机未分配号码</option>
              </select>
              <input type="number" id="exportRandomCount" class="input" value="50" min="1" max="10000" style="width:120px;" title="随机导出数量（仅在选择随机时生效）">
              <select class="select" id="exportAssignTo" style="min-width:200px;">
                <option value="">导出时不分配（可选）</option>
                <!-- 人员列表将通过JS动态添加 -->
              </select>
            </div>
            <div id="randomExportHint" class="form-hint">选择随机导出时，将从所有未分配号码中随机选择指定数量；可在导出时选择将这些号码一并分配给某人。</div>
          </div>
          
          <div class="form-item">
            <label class="form-label">导出格式</label>
            <select class="select" id="exportFormat">
              <option value="csv">CSV（推荐）</option>
              <option value="txt">TXT（每行一条记录）</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" onclick="closeExportModal()">取消</button>
          <button class="btn btn-primary" onclick="doExport()">开始导出</button>
        </div>
      </div>
    </div>

    <!-- 1. 号码列表页 -->
    <div class="page active" id="listPage">
      <!-- 顶部导航 -->
      <div class="header">
        <div class="logo">
          <div class="logo-icon">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
              <ellipse cx="16" cy="28" rx="12" ry="4" fill="#aee2ff"/>
              <circle cx="16" cy="16" r="12" fill="#fff7fa" stroke="#aee2ff" stroke-width="2"/>
              <ellipse cx="16" cy="19" rx="6" ry="3" fill="#f6d6ff"/>
              <circle cx="16" cy="14" r="5" fill="#f6d6ff"/>
              <ellipse cx="13" cy="13" rx="1.2" ry="0.8" fill="#7fbcff"/>
              <ellipse cx="19" cy="13" rx="1.2" ry="0.8" fill="#7fbcff"/>
              <path d="M14 19 Q16 21 18 19" stroke="#7fbcff" stroke-width="1.5" fill="none"/>
            </svg>
          </div>
          US号码管家
        </div>
        <div class="header-actions">
          <button class="btn btn-success" onclick="showAddForm()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="10" fill="#aee2ff"/><path d="M10 5v10M5 10h10" stroke="#7fbcff" stroke-width="2"/></svg> 新增号码
          </button>
          <button class="btn btn-primary" onclick="openImportModal()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><rect x="3" y="3" width="14" height="14" rx="4" fill="#f6d6ff"/><path d="M10 7v6M7 10h6" stroke="#7fbcff" stroke-width="2"/></svg> 批量导入
          </button>
          <button class="btn btn-primary" onclick="openExportModal()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><rect x="3" y="3" width="14" height="14" rx="4" fill="#f6d6ff"/><path d="M10 13V7M7 10h6" stroke="#7fbcff" stroke-width="2"/></svg> 批量导出
          </button>
          <button class="btn btn-default" onclick="refreshList()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="9" stroke="#aee2ff" stroke-width="2"/><path d="M10 3v4M10 13v4M3 10h4M13 10h4" stroke="#7fbcff" stroke-width="2"/></svg> 刷新
          </button>
        </div>
      </div>

      <!-- 主导航 -->
      <div class="main-nav">
        <button class="btn btn-primary" onclick="showPage('listPage')">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><rect x="2" y="2" width="14" height="14" rx="4" fill="#aee2ff"/><rect x="5" y="5" width="8" height="8" rx="2" fill="#fff7fa"/></svg> 号码管理
        </button>
        <button class="btn btn-default" onclick="showPage('personPage')">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><ellipse cx="6" cy="7" rx="3" ry="3" fill="#aee2ff"/><ellipse cx="12" cy="7" rx="3" ry="3" fill="#aee2ff"/><rect x="3" y="11" width="12" height="4" rx="2" fill="#fff7fa"/></svg> 人员管理
        </button>
      </div>

      <!-- 筛选区 -->
      <div class="card">
        <div class="filter-bar">
            <select class="select" id="statusFilter" onchange="filterNumbers()">
            <option value="">全部状态</option>
            <option value="used">已使用（有分配人）</option>
            <option value="unused">未使用（无分配人）</option>
          </select>

          <select class="select" id="assigneeFilter" onchange="filterNumbers()">
            <option value="">全部人员</option>
            <!-- 人员列表将通过JS动态添加 -->
          </select>

            <input type="text" class="input input-search" id="searchInput" 
                   placeholder="搜索号码/姓名/被分配人" oninput="filterNumbers()">

            <!-- 排序控制 -->
            <select class="select" id="sortField" onchange="filterNumbers()" style="max-width:180px;">
              <option value="">默认排序（ID）</option>
              <option value="phoneNumber">号码</option>
              <option value="name">姓名</option>
              <option value="age">年龄</option>
              <option value="assignee">被分配人</option>
              <option value="importTime">导入时间</option>
            </select>
            <select class="select" id="sortDirection" onchange="filterNumbers()" style="width:120px;">
              <option value="desc">降序</option>
              <option value="asc">升序</option>
            </select>
        </div>
      </div>

      <!-- 号码表格 -->
      <div class="card">
        <div class="stats">
          共 <span id="totalCount">0</span> 条 
          <span class="stats-used" id="usedCount">已使用 0 条</span>
          <span class="stats-unused" id="unusedCount">未使用 0 条</span>
        </div>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                    <th class="col-id" data-field="id" onclick="toggleSort('id')" style="cursor:pointer">序号 <span id="sort-id"></span></th>
                    <th class="col-phone" data-field="phoneNumber" onclick="toggleSort('phoneNumber')" style="cursor:pointer">美国号码 <span id="sort-phoneNumber"></span></th>
                    <th class="col-name" data-field="name" onclick="toggleSort('name')" style="cursor:pointer">姓名 <span id="sort-name"></span></th>
                    <th class="col-age" data-field="age" onclick="toggleSort('age')" style="cursor:pointer">年龄 <span id="sort-age"></span></th>
                    <th class="col-assignee" data-field="assignee" onclick="toggleSort('assignee')" style="cursor:pointer">被分配人 <span id="sort-assignee"></span></th>
                    <th class="col-importTime" data-field="importTime" onclick="toggleSort('importTime')" style="cursor:pointer">导入时间 <span id="sort-importTime"></span></th>
                    <th class="col-fileName" data-field="fileName" onclick="toggleSort('fileName')" style="cursor:pointer">导入文件名 <span id="sort-fileName"></span></th>
                    <th class="col-actions">操作</th>
              </tr>
            </thead>
            <tbody id="numberTableBody">
              <!-- 表格内容由JS动态生成 -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 2. 编辑/新增号码页 -->
    <div class="page" id="editPage">
      <div class="header">
        <button class="btn btn-default" onclick="returnToList()">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M12 9H6M9 6l-3 3 3 3" stroke="#7fbcff" stroke-width="2"/></svg> 返回列表
        </button>
        <h2 id="editTitle">编辑号码</h2>
      </div>

      <div class="card">
        <form class="form" id="editForm" onsubmit="saveNumber(event)">
          <input type="hidden" id="editId"> <!-- 隐藏的ID字段 -->
          <input type="hidden" id="editFileName"> <!-- 导入文件名（仅导入时设置） -->

          <div class="form-row">
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">美国号码 <span style="color: #f56c6c;">*</span></label>
                <input type="text" class="input" id="editPhone" placeholder="+1-XXX-XXX-XXXX" 
                      pattern="^\+1-\d{3}-\d{3}-\d{4}$" required>
                <div class="form-hint">请输入美国号码，格式：+1-XXX-XXX-XXXX</div>
              </div>
            </div>
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">姓名 <span style="color: #f56c6c;">*</span></label>
                <input type="text" class="input" id="editName" placeholder="请输入姓名" required>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">年龄 <span style="color: #f56c6c;">*</span></label>
                <input type="number" class="input" id="editAge" placeholder="请输入年龄" min="0" max="150" required>
                <div class="form-hint">请输入有效的年龄（0-150）</div>
              </div>
            </div>
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">被分配人</label>
                <select class="select" id="editAssigneeSelect">
                  <option value="">未分配</option>
                  <!-- 人员列表将通过JS动态添加 -->
                </select>
                <div style="display: flex; gap: 10px; margin-top: 8px;">
                  <input type="text" class="input" id="editAssigneeText" placeholder="或直接输入">
                  <button type="button" class="btn btn-sm btn-default" onclick="addPersonFromEdit()">
                    + 添加
                  </button>
                </div>
                <div class="form-hint">从已有人员选择或直接输入新人员</div>
              </div>
            </div>
          </div>

          <div class="form-item" id="importFileNameContainer" style="display: none;">
            <label class="form-label">导入文件名</label>
            <input type="text" class="input" id="editDisplayFileName" disabled>
            <div class="form-hint">该字段由系统自动生成，不可修改</div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-default" onclick="returnToList()">
              取消
            </button>
            <button type="submit" class="btn btn-primary">
              保存
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 3. 使用记录页 -->
    <div class="page" id="logPage">
      <div class="header">
        <button class="btn btn-default" onclick="returnToList()">
          ← 返回列表
        </button>
        <h2 id="logTitle">号码使用记录</h2>
      </div>

      <div class="card">
        <div id="logPhone" class="form-hint" style="margin-bottom: 20px; font-size: 14px;"></div>
        
        <div class="timeline" id="timelineContainer">
          <!-- 时间线内容由JS动态生成 -->
          <div class="timeline-item">
            <div class="timeline-dot">ℹ️</div>
            <div class="timeline-content">
              <div class="timeline-time">请选择一个号码查看记录</div>
              <div class="timeline-title">使用记录将显示在这里</div>
              <div class="timeline-detail">包括号码的分配、修改和状态变更历史</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 4. 人员管理页 -->
    <div class="page" id="personPage">
      <div class="header">
        <button class="btn btn-default" onclick="returnToList()">
          ← 返回号码管理
        </button>
        <h2>人员管理</h2>
      </div>

      <div class="card">
        <div class="filter-bar">
          <input type="text" class="input input-search" id="personSearchInput" 
                 placeholder="搜索人员姓名/用途" oninput="filterPersons()">
          <button class="btn btn-success" onclick="showAddPersonForm()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="10" fill="#aee2ff"/><path d="M10 5v10M5 10h10" stroke="#7fbcff" stroke-width="2"/></svg> 新增人员
          </button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><ellipse cx="7" cy="8" rx="4" ry="4" fill="#aee2ff"/><ellipse cx="13" cy="8" rx="4" ry="4" fill="#aee2ff"/><rect x="4" y="13" width="12" height="4" rx="2" fill="#fff7fa"/></svg> 人员列表
        </div>
        <div id="personListContainer" class="person-list">
          <!-- 人员列表由JS动态生成 -->
        </div>
      </div>

      <!-- 新增/编辑人员表单 -->
      <div class="card" id="personFormCard" style="display: none;">
        <div class="section-title">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><ellipse cx="10" cy="8" rx="6" ry="6" fill="#aee2ff"/><rect x="6" y="14" width="8" height="4" rx="2" fill="#fff7fa"/></svg> <span id="personFormTitle">新增人员</span>
        </div>
        <form class="form" id="personForm" onsubmit="savePerson(event)">
          <input type="hidden" id="personId">

          <div class="form-row">
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">姓名 <span style="color: #f56c6c;">*</span></label>
                <input type="text" class="input" id="personName" placeholder="请输入人员姓名" required>
              </div>
            </div>
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">用途/部门</label>
                <input type="text" class="input" id="personPurpose" placeholder="如：亚马逊、客服部">
                <div class="form-hint">用于区分同一姓名的不同用途</div>
              </div>
            </div>
          </div>

          <div class="form-item">
            <label class="form-label">备注</label>
            <textarea class="input" style="min-height:80px;" id="personRemark" placeholder="添加人员相关备注（可选）"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-default" onclick="hidePersonForm()">
              取消
            </button>
            <button type="submit" class="btn btn-primary">
              保存
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // 全局数据存储
    // 使用 var 以便在测试环境（jsdom）中通过 window.xxx 访问和修改
    var numberList = [];    // 号码列表
    var logList = [];       // 操作日志
    var personList = [];    // 人员列表
    var parsedPasteData = []; // 解析后的粘贴数据
    var currentNumberId = null;
    var currentPersonId = null;
  // 排序状态
  var sortField = ''; // 默认为空（按 id 保持原始顺序）
  var sortDirection = 'desc'; // 'asc' 或 'desc'

    // 确保在任何环境中都有 localStorage 变量可用（避免在测试环境中 ReferenceError）
    (function(){
      var stub = (function(){
        var store = Object.create(null);
        return {
          getItem: function(key) { return store.hasOwnProperty(key) ? store[key] : null; },
          setItem: function(key, value) { store[key] = String(value); },
          removeItem: function(key) { delete store[key]; },
          clear: function() { store = Object.create(null); }
        };
      })();

      try {
        if (typeof window !== 'undefined' && window.localStorage) {
          // 浏览器/jsdom 环境
          try { localStorage = window.localStorage; } catch (e) { localStorage = window.localStorage || stub; }
        } else {
          localStorage = stub;
        }
      } catch (e) {
        try { localStorage = global.localStorage || stub; } catch (e2) { localStorage = stub; }
      }

      // 保证 window.localStorage 指向相同实现
      try { if (typeof window !== 'undefined') window.localStorage = localStorage; } catch (e) {}
    })();

    // 在无 localStorage 的环境（例如某些测试环境）提供简单全局回退
    (function(){
      try {
        if (typeof localStorage === 'undefined' || localStorage === null) {
          var store = Object.create(null);
          var stub = {
            getItem: function(key) { return store.hasOwnProperty(key) ? store[key] : null; },
            setItem: function(key, value) { store[key] = String(value); },
            removeItem: function(key) { delete store[key]; },
            clear: function() { store = Object.create(null); }
          };
          try { window.localStorage = stub; } catch(e) {}
          try { global.localStorage = stub; } catch(e) {}
          try { localStorage = stub; } catch(e) {}
        }
      } catch (e) {
        // 忽略
      }
    })();

    // 初始化页面
    window.onload = function() {
      showLoading("加载数据中...");
      // 从本地存储加载数据
      loadAllData();
      // 渲染列表
      renderNumberList(getSortedFilteredData());
      renderPersonList();
      updatePersonSelectors();
      hideLoading();
    };

    // 页面切换 - 返回列表页
    function returnToList() {
      showToast("返回列表", "success");
      document.getElementById('listPage').classList.add('active');
      document.getElementById('editPage').classList.remove('active');
      document.getElementById('logPage').classList.remove('active');
      document.getElementById('personPage').classList.remove('active');
    }

    // --- Safe localStorage wrapper with in-memory fallback ---
    var __inMemoryStore = {};
    function safeGetItem(key) {
      try {
        if (typeof window !== 'undefined' && window.localStorage && typeof window.localStorage.getItem === 'function') {
          return window.localStorage.getItem(key);
        }
      } catch (e) {}
      return __inMemoryStore.hasOwnProperty(key) ? __inMemoryStore[key] : null;
    }
    function safeSetItem(key, value) {
      try {
        if (typeof window !== 'undefined' && window.localStorage && typeof window.localStorage.setItem === 'function') {
          return window.localStorage.setItem(key, value);
        }
      } catch (e) {}
      __inMemoryStore[key] = String(value);
    }
    function safeRemoveItem(key) {
      try {
        if (typeof window !== 'undefined' && window.localStorage && typeof window.localStorage.removeItem === 'function') {
          return window.localStorage.removeItem(key);
        }
      } catch (e) {}
      delete __inMemoryStore[key];
    }
    function safeClear() {
      try {
        if (typeof window !== 'undefined' && window.localStorage && typeof window.localStorage.clear === 'function') {
          return window.localStorage.clear();
        }
      } catch (e) {}
      __inMemoryStore = {};
    }

    // 自动化策略：在测试或无对话框实现环境中，自动允许所有 confirm
    try {
      if (typeof window !== 'undefined') {
        // 如果原生 confirm 存在，包裹一层 try/catch：若调用抛出（例如 jsdom 未实现），则默认返回 true
        if (typeof window.confirm === 'function') {
          const __orig_confirm = window.confirm;
          window.confirm = function(msg) {
            try {
              return __orig_confirm(msg);
            } catch (e) {
              return true;
            }
          }
        } else {
          // 完全不存在时，直接提供一个始终返回 true 的实现
          window.confirm = function() { return true; };
        }
      }
    } catch (e) {}

    // 为 URL.createObjectURL 提供简单回退（jsdom 环境可能未实现）
    try {
      if (typeof window !== 'undefined' && (!window.URL || typeof window.URL.createObjectURL !== 'function')) {
        window.URL = window.URL || {};
        window.URL.createObjectURL = function(blob) {
          try {
            // 尝试读取 blob 内容（如果可能）
            if (blob && typeof blob.text === 'function') {
              return 'data:;base64,' + Buffer.from(blob.text ? blob.text() : '').toString('base64');
            }
          } catch (e) {}
          return 'data:application/octet-stream,generated';
        };
      }
    } catch (e) {}

    // 通用页面切换
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
      
      // 如果切换到人员页面，重新渲染人员列表
      if (pageId === 'personPage') {
        renderPersonList();
      }
    }

    // 切换导入方式选项卡
    function switchImportTab(tabName) {
      // 隐藏所有内容
      document.querySelectorAll('.import-tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // 取消所有选项卡的选中状态
      document.querySelectorAll('.import-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // 激活选中的选项卡和内容
      document.getElementById(`${tabName}ImportContent`).classList.add('active');
      document.querySelector(`.import-tab[onclick="switchImportTab('${tabName}')"]`).classList.add('active');
    }

    // 解析粘贴的数据
    function parsePasteData() {
      const pasteData = document.getElementById('pasteData').value.trim();
      if (!pasteData) {
        showToast("请输入要解析的数据", "error");
        return;
      }
      
      parsedPasteData = [];
      const lines = pasteData.split('\n');
      const errors = [];
      
      lines.forEach((line, index) => {
        const lineNumber = index + 1;
        const trimmedLine = line.trim();
        if (!trimmedLine) return;
        
  const fields = parseCSVLine(trimmedLine);
        let phoneNumber, name, age, assignee = '';
        
        // 解析字段
        if (fields.length >= 3) {
          phoneNumber = fields[0].trim();
          name = fields[1].trim();
          age = fields[2].trim();
          if (fields.length >= 4) assignee = fields[3].trim();
        } else {
          errors.push(`第 ${lineNumber} 行：数据格式错误，至少需要包含3个字段（号码,姓名,年龄）`);
          return;
        }
        
        // 验证号码格式
        const phonePattern = /^\+1-\d{3}-\d{3}-\d{4}$/;
        if (!phonePattern.test(phoneNumber)) {
          errors.push(`第 ${lineNumber} 行：号码格式错误，应为 +1-XXX-XXX-XXXX`);
        }
        
        // 验证姓名
        if (!name) {
          errors.push(`第 ${lineNumber} 行：姓名不能为空`);
        }
        
        // 验证年龄
        const ageNum = parseInt(age);
        if (isNaN(ageNum) || ageNum < 0 || ageNum > 150) {
          errors.push(`第 ${lineNumber} 行：年龄必须是0-150之间的数字`);
        }
        
        // 添加到解析数据列表
        parsedPasteData.push({
          phoneNumber,
          name,
          age: ageNum,
          assignee,
          isValid: errors.filter(e => e.startsWith(`第 ${lineNumber} 行`)).length === 0
        });
      });
      
      // 显示预览
      document.getElementById('pastePreviewContainer').style.display = 'block';
      document.getElementById('previewCount').textContent = parsedPasteData.length;
      
      // 渲染预览内容
      const previewContent = document.getElementById('pastePreviewContent');
      previewContent.innerHTML = '';
      
      parsedPasteData.forEach((item, index) => {
        const row = document.createElement('div');
        row.className = `paste-preview-row ${item.isValid ? '' : 'error'}`;
        
        row.innerHTML = `
          <div>${index + 1}</div>
          <div>${item.phoneNumber}</div>
          <div>${item.name}</div>
          <div>${item.age}</div>
          <div>${item.assignee || '-'}</div>
        `;
        
        previewContent.appendChild(row);
      });
      
      // 显示错误信息
      const errorContainer = document.getElementById('pasteErrors');
      if (errors.length > 0) {
        errorContainer.textContent = `发现 ${errors.length} 个错误：${errors.join('；')}`;
      } else {
        errorContainer.textContent = '';
      }
    }

    // 加载所有数据
    function loadAllData() {
      // 从本地存储获取，没有则初始化示例数据
      const savedNumbers = safeGetItem('usNumbers');
      const savedLogs = safeGetItem('usLogs');
      const savedPersons = safeGetItem('usPersons');

      // 加载号码数据
      if (savedNumbers) {
        numberList = JSON.parse(savedNumbers);
      } else {
        // 初始化示例数据（包含所有要求的字段）
        numberList = [
          { 
            id: 1, 
            phoneNumber: "+1-212-555-1234", 
            name: "张三",
            age: 30,
            assignee: "亚马逊团队", 
            importTime: "2024-09-20 15:30",
            fileName: "initial_data.csv"
          },
          { 
            id: 2, 
            phoneNumber: "+1-310-555-6789", 
            name: "李四",
            age: 28,
            assignee: "", 
            importTime: "2024-09-21 10:15",
            fileName: "initial_data.csv"
          },
          { 
            id: 3, 
            phoneNumber: "+1-773-555-4321", 
            name: "王五",
            age: 35,
            assignee: "Shopify团队", 
            importTime: "2024-09-21 14:00",
            fileName: "october_batch.csv"
          },
          { 
            id: 4, 
            phoneNumber: "+1-415-555-9876", 
            name: "赵六",
            age: 25,
            assignee: "", 
            importTime: "2024-09-22 09:45",
            fileName: "october_batch.csv"
          }
        ];
        saveNumbersToStorage();
      }

      // 加载日志数据
      if (savedLogs) {
        logList = JSON.parse(savedLogs);
      } else {
        logList = [
          { id: 1, numberId: 1, action: "分配", content: "分配给 亚马逊团队", time: "2024-09-20 15:30", type: "used" },
          { id: 2, numberId: 3, action: "分配", content: "分配给 Shopify团队", time: "2024-09-21 14:00", type: "used" }
        ];
        saveLogsToStorage();
      }

      // 加载人员数据
      if (savedPersons) {
        personList = JSON.parse(savedPersons);
      } else {
        personList = [
          { id: 1, name: "亚马逊团队", purpose: "电商平台", remark: "负责亚马逊相关业务", displayName: "亚马逊团队" },
          { id: 2, name: "Shopify团队", purpose: "电商平台", remark: "负责Shopify相关业务", displayName: "Shopify团队" },
          { id: 3, name: "客服部", purpose: "客户服务", remark: "负责客户咨询", displayName: "客服部" }
        ];
        savePersonsToStorage();
      }
    }

    // 保存数据到本地存储
    function saveNumbersToStorage() {
      safeSetItem('usNumbers', JSON.stringify(numberList));
    }
    function saveLogsToStorage() {
      safeSetItem('usLogs', JSON.stringify(logList));
    }
    function savePersonsToStorage() {
      safeSetItem('usPersons', JSON.stringify(personList));
      // 更新所有人员选择器
      updatePersonSelectors();
    }

    // 更新所有人员选择器
    function updatePersonSelectors() {
      // 更新分配人筛选器
      const assigneeFilter = document.getElementById('assigneeFilter');
      assigneeFilter.innerHTML = '<option value="">全部人员</option>';
      
      // 更新编辑页的人员选择器
      const editAssigneeSelect = document.getElementById('editAssigneeSelect');
      editAssigneeSelect.innerHTML = '<option value="">未分配</option>';
      
      // 更新导入模态框的默认分配人选择器
      const defaultAssignee = document.getElementById('defaultAssignee');
      defaultAssignee.innerHTML = '<option value="">不设置默认值</option>';
      
      // 更新粘贴导入的分配人选择器
      const pasteAssignee = document.getElementById('pasteAssignee');
      pasteAssignee.innerHTML = '<option value="">不分配</option>';
      
      // 添加人员选项
      personList.forEach(person => {
        // 筛选器选项
        const filterOption = document.createElement('option');
        filterOption.value = person.displayName;
        filterOption.textContent = person.displayName;
        assigneeFilter.appendChild(filterOption);
        
        // 编辑页选项
        const editOption = document.createElement('option');
        editOption.value = person.displayName;
        editOption.textContent = person.displayName;
        editAssigneeSelect.appendChild(editOption);
        
        // 导入模态框选项
        const importOption = document.createElement('option');
        importOption.value = person.displayName;
        importOption.textContent = person.displayName;
        defaultAssignee.appendChild(importOption);
        
        // 粘贴导入选项
        const pasteOption = document.createElement('option');
        pasteOption.value = person.displayName;
        pasteOption.textContent = person.displayName;
        pasteAssignee.appendChild(pasteOption);

          // 导出模态框的分配人选择器
          const exportAssignSelect = document.getElementById('exportAssignTo');
          if (exportAssignSelect) {
            const exportOption = document.createElement('option');
            exportOption.value = person.displayName;
            exportOption.textContent = person.displayName;
            exportAssignSelect.appendChild(exportOption);
          }
      });
    }

    // 渲染号码列表
    function renderNumberList(filteredData = null) {
      const data = filteredData || numberList;
      const tableBody = document.getElementById('numberTableBody');
      tableBody.innerHTML = '';

      if (data.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" style="padding: 30px;">暂无号码数据，请点击"新增号码"或"批量导入"添加</td>
          </tr>
        `;
      } else {
        data.forEach((item, index) => {
          const tr = document.createElement('tr');
          // index + 1 表示在当前筛选/排序结果中的序号
          tr.innerHTML = `
            <td class="col-id">${index + 1}</td>
            <td class="col-phone phone-number">${item.phoneNumber}</td>
            <td class="col-name">${item.name}</td>
            <td class="col-age">${item.age}</td>
            <td class="col-assignee">
              ${item.assignee 
                ? `<span class="status-used">${item.assignee}</span>` 
                : `<span class="status-unused">未分配</span>`
              }
            </td>
            <td class="col-importTime">${item.importTime}</td>
            <td class="col-fileName">${item.fileName || '-'}</td>
            <td class="col-actions">
              <button class="oper-btn" onclick="editNumber(${item.id})">编辑</button>
              <button class="oper-btn" onclick="viewLog(${item.id})">记录</button>
              <button class="oper-btn oper-btn-danger" onclick="deleteNumber(${item.id})">删除</button>
            </td>
          `;
          
          tableBody.appendChild(tr);
        });
      }

      // 更新统计信息
      updateStats(data);
    }

    // 切换列排序（表头点击）
    function toggleSort(field) {
      if (sortField === field) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortField = field;
        // 保持默认方向（当点击非 id 字段时使用 asc 更直观）
        sortDirection = field === 'id' ? 'desc' : 'asc';
      }
      // 更新下拉选择的同步显示
      const sf = document.getElementById('sortField');
      const sd = document.getElementById('sortDirection');
      if (sf) sf.value = sortField || '';
      if (sd) sd.value = sortDirection || 'desc';

      // 更新表头指示器
      updateSortIndicators();
      filterNumbers();
    }

    function updateSortIndicators() {
      const fields = ['id','phoneNumber','name','age','assignee','importTime','fileName'];
      fields.forEach(f => {
        const el = document.getElementById('sort-' + f);
        if (!el) return;
        if (sortField === f) {
          el.textContent = sortDirection === 'asc' ? '▲' : '▼';
        } else {
          el.textContent = '';
        }
      });
    }

    // 通用比较函数（支持空值）
    function compareByField(a, b, field) {
      const va = a[field] == null ? '' : a[field];
      const vb = b[field] == null ? '' : b[field];

      // 若为数字字段
      if (field === 'age' || field === 'id') {
        const na = Number(va) || 0;
        const nb = Number(vb) || 0;
        return na - nb;
      }

      // 尝试解析日期
      if (field === 'importTime') {
        const da = new Date(va).getTime() || 0;
        const db = new Date(vb).getTime() || 0;
        return da - db;
      }

      // 字符串比较，忽略大小写
      const sa = String(va).toLowerCase();
      const sb = String(vb).toLowerCase();
      if (sa < sb) return -1;
      if (sa > sb) return 1;
      return 0;
    }

    // 更新统计信息
    function updateStats(data) {
      const total = data.length;
      const used = data.filter(item => item.assignee).length;
      const unused = total - used;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('usedCount').textContent = `已使用 ${used} 条`;
      document.getElementById('unusedCount').textContent = `未使用 ${unused} 条`;
    }

    // 筛选号码
    function filterNumbers() {
      const statusFilter = document.getElementById('statusFilter').value;
      const assigneeFilter = document.getElementById('assigneeFilter').value;
      const searchKeyword = document.getElementById('searchInput').value.toLowerCase();

      // 同步从下拉选择器读取排序设置（如果用户通过下拉选择）
      const sf = document.getElementById('sortField');
      const sd = document.getElementById('sortDirection');
      if (sf) sortField = sf.value || '';
      if (sd) sortDirection = sd.value || sortDirection;
      updateSortIndicators();

  const filtered = numberList.filter(item => {
        // 状态筛选
        if (statusFilter === 'used' && !item.assignee) return false;
        if (statusFilter === 'unused' && item.assignee) return false;
        
        // 人员筛选
        if (assigneeFilter && item.assignee !== assigneeFilter) return false;
        
        // 搜索筛选
        if (searchKeyword && !(
          item.phoneNumber.toLowerCase().includes(searchKeyword) || 
          item.name.toLowerCase().includes(searchKeyword) ||
          (item.assignee && item.assignee.toLowerCase().includes(searchKeyword))
        )) return false;
        
        return true;
      });

      // 对过滤后的结果应用排序并渲染
      const sorted = (function(arr) {
        if (!sortField || sortField === '') return arr.slice();
        return arr.slice().sort((a,b) => {
          const cmp = compareByField(a,b,sortField);
          return sortDirection === 'asc' ? cmp : -cmp;
        });
      })(filtered);

      renderNumberList(sorted);
    }


    // 显示新增号码表单
    function showAddForm() {
      document.getElementById('editTitle').textContent = '新增号码';
      document.getElementById('editForm').reset();
      document.getElementById('editId').value = '';
      document.getElementById('editAssigneeText').value = '';
      document.getElementById('editFileName').value = '';
      document.getElementById('importFileNameContainer').style.display = 'none';
      showPage('editPage');
    }

    // 编辑号码
    function editNumber(id) {
      const item = numberList.find(item => item.id === id);
      if (item) {
        document.getElementById('editTitle').textContent = '编辑号码';
        document.getElementById('editId').value = item.id;
        document.getElementById('editPhone').value = item.phoneNumber;
        document.getElementById('editName').value = item.name;
        document.getElementById('editAge').value = item.age;
        document.getElementById('editAssigneeSelect').value = item.assignee || '';
        document.getElementById('editAssigneeText').value = '';
        document.getElementById('editFileName').value = item.fileName || '';
        document.getElementById('editDisplayFileName').value = item.fileName || '';
        
        // 显示导入文件名（如果存在）
        if (item.fileName) {
          document.getElementById('importFileNameContainer').style.display = 'block';
        } else {
          document.getElementById('importFileNameContainer').style.display = 'none';
        }
        
        showPage('editPage');
      }
    }

    // 从编辑页添加新人员
    function addPersonFromEdit() {
      const assigneeText = document.getElementById('editAssigneeText').value.trim();
      if (!assigneeText) {
        showToast("请输入人员信息", "error");
        return;
      }
      
      // 尝试解析姓名和用途（格式：姓名（用途））
      let name, purpose;
      const match = assigneeText.match(/^(.*?)(?:\((.*)\))?$/);
      if (match) {
        name = match[1].trim();
        purpose = match[2] ? match[2].trim() : '';
      } else {
        name = assigneeText;
        purpose = '';
      }
      
      if (!name) {
        showToast("请输入人员姓名", "error");
        return;
      }
      
      // 创建新人员
      const newId = personList.length > 0 
        ? Math.max(...personList.map(p => p.id)) + 1 
        : 1;
      
      const newPerson = {
        id: newId,
        name,
        purpose,
        remark: '',
        displayName: assigneeText
      };
      
      personList.push(newPerson);
      savePersonsToStorage();
      
      // 选中新添加的人员
      document.getElementById('editAssigneeSelect').value = assigneeText;
      document.getElementById('editAssigneeText').value = '';
      
      showToast(`已添加新人员：${assigneeText}`, "success");
    }

    // 保存号码
    function saveNumber(event) {
      event.preventDefault();
      
      const id = document.getElementById('editId').value;
      const phoneNumber = document.getElementById('editPhone').value;
      const name = document.getElementById('editName').value.trim();
      const age = parseInt(document.getElementById('editAge').value);
      const assigneeSelect = document.getElementById('editAssigneeSelect').value;
      const assigneeText = document.getElementById('editAssigneeText').value.trim();
      const assignee = assigneeText || assigneeSelect;
      const fileName = document.getElementById('editFileName').value;
      
      // 验证必填字段
      if (!name) {
        showToast("请输入姓名", "error");
        return;
      }
      
      if (isNaN(age) || age < 0 || age > 150) {
        showToast("请输入有效的年龄（0-150）", "error");
        return;
      }
      
      // 验证号码格式
      const phonePattern = /^\+1-\d{3}-\d{3}-\d{4}$/;
      if (!phonePattern.test(phoneNumber)) {
        showToast("请输入正确的美国号码格式：+1-XXX-XXX-XXXX", "error");
        return;
      }
      
      // 生成当前时间
      const now = new Date();
      const timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
      
      showLoading("保存中...");
      
      setTimeout(() => { // 模拟网络延迟
        if (id) {
          // 更新现有号码
          const index = numberList.findIndex(item => item.id === parseInt(id));
          if (index !== -1) {
            // 记录状态变更
            const oldAssignee = numberList[index].assignee;
            const oldName = numberList[index].name;
            const oldAge = numberList[index].age;
            const oldPhone = numberList[index].phoneNumber;
            
            numberList[index] = {
              ...numberList[index],
              phoneNumber,
              name,
              age,
              assignee,
              fileName, // 保留导入文件名不变
              importTime: numberList[index].importTime // 保留原始导入时间
            };
            
            // 生成日志内容
            let logContent = [];
            if (oldPhone !== phoneNumber) logContent.push(`号码从 "${oldPhone}" 变更为 "${phoneNumber}"`);
            if (oldName !== name) logContent.push(`姓名从 "${oldName}" 变更为 "${name}"`);
            if (oldAge !== age) logContent.push(`年龄从 "${oldAge}" 变更为 "${age}"`);
            if (oldAssignee !== assignee) logContent.push(`被分配人从 "${oldAssignee || '未分配'}" 变更为 "${assignee || '未分配'}"`);
            
            // 添加日志记录
            addLog(parseInt(id), '更新', logContent.join('；'), assignee ? 'used' : 'unused');
            
            showToast('号码更新成功', "success");
          }
        } else {
          // 检查号码是否已存在
          const exists = numberList.some(item => item.phoneNumber === phoneNumber);
          if (exists) {
            hideLoading();
            showToast("该号码已存在", "error");
            return;
          }
          
          // 新增号码（手动新增的没有导入文件名）
          const newId = numberList.length > 0 
            ? Math.max(...numberList.map(item => item.id)) + 1 
            : 1;
            
          numberList.push({
            id: newId,
            phoneNumber,
            name,
            age,
            assignee,
            importTime: timeStr,
            fileName: '' // 手动新增的无导入文件名
          });
          
          // 添加日志记录
          let logAction = assignee ? '分配' : '新增';
          let logContent = assignee ? `分配给 "${assignee}"` : '新增未分配号码';
          logContent += `（姓名：${name}，年龄：${age}）`;
          
          addLog(newId, logAction, logContent, assignee ? 'used' : 'unused');
          
          showToast('号码新增成功', "success");
        }
        
        // 保存数据并返回列表页
        saveNumbersToStorage();
        renderNumberList();
        returnToList();
        hideLoading();
      }, 500);
    }

    // 添加日志记录
    function addLog(numberId, action, content, type) {
      const now = new Date();
      const timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
      
      const newLog = {
        id: logList.length > 0 ? Math.max(...logList.map(log => log.id)) + 1 : 1,
        numberId,
        action,
        content,
        time: timeStr,
        type
      };
      
      logList.push(newLog);
      saveLogsToStorage();
    }

    // 查看使用记录
    function viewLog(numberId) {
      currentNumberId = numberId;
      const number = numberList.find(item => item.id === numberId);
      
      if (number) {
        document.getElementById('logTitle').textContent = `号码使用记录 - ${number.phoneNumber}`;
        document.getElementById('logPhone').textContent = 
          `号码：${number.phoneNumber} | 姓名：${number.name} | 年龄：${number.age} | 状态：${number.assignee ? '已使用' : '未使用'} | 被分配人：${number.assignee || '无'}`;
        
        // 筛选该号码的日志
        const numberLogs = logList.filter(log => log.numberId === numberId)
                                 .sort((a, b) => new Date(b.time) - new Date(a.time));
        
        const timelineContainer = document.getElementById('timelineContainer');
        timelineContainer.innerHTML = '';
        
        if (numberLogs.length === 0) {
          timelineContainer.innerHTML = `
            <div class="timeline-item">
              <div class="timeline-dot">ℹ️</div>
              <div class="timeline-content">
                <div class="timeline-time">暂无记录</div>
                <div class="timeline-title">该号码暂无使用记录</div>
              </div>
            </div>
          `;
        } else {
          numberLogs.forEach(log => {
            const item = document.createElement('div');
            item.className = 'timeline-item';
            
            item.innerHTML = `
              <div class="timeline-dot ${log.type}">
                ${log.type === 'used' ? '✓' : '○'}
              </div>
              <div class="timeline-content">
                <div class="timeline-time">${log.time}</div>
                <div class="timeline-title">${log.action}操作</div>
                <div class="timeline-detail">${log.content}</div>
              </div>
            `;
            
            timelineContainer.appendChild(item);
          });
        }
        
        showPage('logPage');
      }
    }

    // 删除号码
    function deleteNumber(id) {
      const number = numberList.find(item => item.id === id);
      if (!number) return;
      
      if (confirm(`确定要删除号码 ${number.phoneNumber}（${number.name}，${number.age}岁）吗？相关记录会被保留。`)) {
        showLoading("删除中...");
        
        setTimeout(() => { // 模拟网络延迟
          const index = numberList.findIndex(item => item.id === id);
          if (index !== -1) {
            numberList.splice(index, 1);
            saveNumbersToStorage();
            
            // 添加删除日志
            addLog(id, '删除', `删除号码 ${number.phoneNumber}（${number.name}，${number.age}岁）`, 'unused');
            
            renderNumberList();
            showToast('号码已删除', "success");
          }
          hideLoading();
        }, 500);
      }
    }

    // 刷新列表
    function refreshList() {
      showLoading("刷新中...");
      
      setTimeout(() => { // 模拟网络请求
        loadAllData();
        renderNumberList();
        renderPersonList();
        showToast('数据已刷新', "success");
        hideLoading();
      }, 800);
    }

    // 批量导入相关函数
    function openImportModal() {
      document.getElementById('importFile').value = '';
      document.getElementById('defaultAssignee').value = '';
      document.getElementById('pasteData').value = '';
      document.getElementById('pastePreviewContainer').style.display = 'none';
      document.getElementById('pasteAssignee').value = '';
      parsedPasteData = [];
      document.getElementById('importModal').classList.add('show');
    }

    function closeImportModal() {
      document.getElementById('importModal').classList.remove('show');
    }

    function downloadImportTemplate() {
      const csvContent = "phoneNumber,name,age,assignee\n" +
                        "+1-212-555-1234,张三,30,亚马逊团队\n" +
                        "+1-310-555-6789,李四,28,Shopify团队";
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', 'us-number-import-template.csv');
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('模板下载成功', "success");
    }

    function doImport() {
      // 判断当前导入来源：如果文件输入中存在文件则优先使用文件导入；否则如果已经解析了粘贴数据则使用粘贴导入
      const fileInput = document.getElementById('importFile');
      const hasFile = fileInput && fileInput.files && fileInput.files.length > 0;

      const isFileImport = hasFile || document.getElementById('fileImportContent').classList.contains('active');

      // 如果没有上传文件但已经解析了粘贴数据，则优先使用粘贴导入
      if (!hasFile && parsedPasteData && parsedPasteData.length > 0) {
        // 强制走粘贴导入分支
        // 下面的逻辑在 else 分支中实现
        // fall through to paste import
      }

      if (isFileImport && hasFile) {
        // 文件导入逻辑
        const defaultAssignee = document.getElementById('defaultAssignee').value;
        
        const file = fileInput.files[0];
        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
          showToast("请选择CSV格式的文件", "error");
          return;
        }
        
        showLoading("导入中...");
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const content = e.target.result;
            const lines = content.split('\n');
            const importedNumbers = [];
            let successCount = 0;
            let duplicateCount = 0;
            let errorCount = 0;
            
            // 生成当前时间
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            
            // 导入文件名（仅保留文件名，不含路径）
            const fileName = file.name;
            
            // 跳过标题行（若首行包含常见字段名），否则从第一行数据开始处理
            let startIndex = 0;
            if (lines.length > 0) {
              const firstLower = lines[0].toLowerCase();
              if (firstLower.includes('phonenumber') || firstLower.includes('phone') || firstLower.includes('name') || firstLower.includes('age')) {
                startIndex = 1; // 视为标题行，跳过
              }
            }
            for (let i = startIndex; i < lines.length; i++) {
              const line = lines[i].trim();
              if (!line) continue; // 跳过空行
              
              // 分割CSV字段（支持引号内逗号）
              const fields = parseCSVLine(line);
              if (fields.length < 3) { // 至少需要phoneNumber, name, age三个字段
                errorCount++;
                continue;
              }
              
              const phoneNumber = fields[0].trim();
              const name = fields[1].trim();
              const age = parseInt(fields[2].trim());
              let assignee = fields.length > 3 ? fields[3].trim() : '';
              
              // 应用默认被分配人
              if (!assignee && defaultAssignee) {
                assignee = defaultAssignee;
              }
              
              // 验证字段
              const phonePattern = /^\+1-\d{3}-\d{3}-\d{4}$/;
              if (!phonePattern.test(phoneNumber)) {
                errorCount++;
                continue;
              }
              
              if (!name) {
                errorCount++;
                continue;
              }
              
              if (isNaN(age) || age < 0 || age > 150) {
                errorCount++;
                continue;
              }
              
              // 检查是否已存在
              const exists = numberList.some(item => item.phoneNumber === phoneNumber);
              if (exists) {
                duplicateCount++;
                continue;
              }
              
              // 添加到导入列表
              importedNumbers.push({
                phoneNumber,
                name,
                age,
                assignee,
                importTime: timeStr,
                fileName: fileName
              });
              
              successCount++;
            }
            
            // 保存导入的号码
            if (importedNumbers.length > 0) {
              const newId = numberList.length > 0 
                ? Math.max(...numberList.map(item => item.id)) 
                : 0;
              
              importedNumbers.forEach((num, index) => {
                numberList.push({
                  ...num,
                  id: newId + index + 1
                });
                
                // 添加日志
                if (num.assignee) {
                  addLog(newId + index + 1, '导入并分配', 
                        `从文件 "${fileName}" 导入，分配给 "${num.assignee}"（姓名：${num.name}，年龄：${num.age}）`, 'used');
                } else {
                  addLog(newId + index + 1, '导入', 
                        `从文件 "${fileName}" 导入（姓名：${num.name}，年龄：${num.age}）`, 'unused');
                }
              });
              
              saveNumbersToStorage();
              renderNumberList();
            }
            
            // 显示导入结果
            showToast(`导入完成：成功${successCount}条，重复${duplicateCount}条，错误${errorCount}条`, "success");
            closeImportModal();
          } catch (error) {
            showToast(`导入失败：${error.message}`, "error");
          } finally {
            hideLoading();
          }
        };
        
        reader.readAsText(file);
      } else {
        // 粘贴导入逻辑
        if (!parsedPasteData || parsedPasteData.length === 0) {
          showToast("请先粘贴数据并解析", "error");
          return;
        }
        
        // 检查是否有有效数据
        const validData = parsedPasteData.filter(item => item.isValid);
        if (validData.length === 0) {
          showToast("没有可导入的有效数据，请检查并修正错误", "error");
          return;
        }
        
        // 获取统一分配人设置
        const pasteAssignee = document.getElementById('pasteAssignee').value;
        
        showLoading("导入中...");
        
        setTimeout(() => {
          try {
            const importedNumbers = [];
            let successCount = 0;
            let duplicateCount = 0;
            
            // 生成当前时间
            const now = new Date();
            const timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            
            // 处理每条数据
            validData.forEach(item => {
              // 检查是否已存在
              const exists = numberList.some(num => num.phoneNumber === item.phoneNumber);
              if (exists) {
                duplicateCount++;
                return;
              }
              
              // 确定被分配人（如果设置了统一分配人则覆盖）
              const assignee = pasteAssignee || item.assignee;
              
              importedNumbers.push({
                phoneNumber: item.phoneNumber,
                name: item.name,
                age: item.age,
                assignee,
                importTime: timeStr,
                fileName: '粘贴导入' // 标记为粘贴导入
              });
              
              successCount++;
            });
            
            // 保存导入的号码
            if (importedNumbers.length > 0) {
              const newId = numberList.length > 0 
                ? Math.max(...numberList.map(item => item.id)) 
                : 0;
              
              importedNumbers.forEach((num, index) => {
                numberList.push({
                  ...num,
                  id: newId + index + 1
                });
                
                // 添加日志
                if (num.assignee) {
                  addLog(newId + index + 1, '导入并分配', 
                        `粘贴导入，分配给 "${num.assignee}"（姓名：${num.name}，年龄：${num.age}）`, 'used');
                } else {
                  addLog(newId + index + 1, '导入', 
                        `粘贴导入（姓名：${num.name}，年龄：${num.age}）`, 'unused');
                }
              });
              
              saveNumbersToStorage();
              renderNumberList();
            }
            
            // 显示导入结果
            showToast(`导入完成：成功${successCount}条，重复${duplicateCount}条`, "success");
            closeImportModal();
          } catch (error) {
            showToast(`导入失败：${error.message}`, "error");
          } finally {
            hideLoading();
          }
        }, 800);
      }
    }

    // 批量导出相关函数
    function openExportModal() {
      document.getElementById('exportModal').classList.add('show');
    }

    function closeExportModal() {
      document.getElementById('exportModal').classList.remove('show');
    }

    // 获取随机的未分配号码
    function getRandomUnassignedNumbers(count) {
      // 筛选所有未分配的号码
      const unassignedNumbers = numberList.filter(num => !num.assignee);

      // 如果未分配号码不足，返回全部（浅拷贝）
      if (unassignedNumbers.length <= count) {
        return [...unassignedNumbers];
      }

      // 使用Fisher-Yates实现真正的随机不重复抽样
      const arr = [...unassignedNumbers];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }

      return arr.slice(0, count);
    }

    function doExport() {
      // 获取导出选项
      const exportPhone = document.getElementById('exportPhone').checked;
      const exportName = document.getElementById('exportName').checked;
      const exportAge = document.getElementById('exportAge').checked;
      const exportAssignee = document.getElementById('exportAssignee').checked;
      const exportImportTime = document.getElementById('exportImportTime').checked;
      const exportFileName = document.getElementById('exportFileName').checked;
  const exportRange = document.getElementById('exportRange').value;
  const exportFormat = document.getElementById('exportFormat').value;
  const exportRandomCount = parseInt(document.getElementById('exportRandomCount').value) || 50;
  const exportAssignTo = document.getElementById('exportAssignTo').value; // 可选的导出时分配
      
      // 检查是否至少选择了一个字段
      if (!exportPhone && !exportName && !exportAge && !exportAssignee && !exportImportTime && !exportFileName) {
        showToast("请至少选择一个导出字段", "error");
        return;
      }
      
      showLoading("导出中...");
      
      setTimeout(() => { // 模拟处理延迟
        let exportData;
        
        // 根据导出范围获取数据
        if (exportRange === 'random') {
          // 获取指定数量的随机未分配号码（去重）
          exportData = getRandomUnassignedNumbers(Math.max(1, Math.min(10000, exportRandomCount)));
        } else if (exportRange === 'filtered') {
          exportData = getSortedFilteredData();
        } else { // 'all'
          exportData = numberList;
        }
        
        if (exportData.length === 0) {
          hideLoading();
          showToast("没有可导出的数据", "error");
          return;
        }
        
        // 显示实际导出数量（特别是随机导出时）
  const actualCount = exportData.length;
        let rangeText = "";
        if (exportRange === 'random') {
          rangeText = `随机${actualCount}个未分配号码`;
        } else if (exportRange === 'filtered') {
          rangeText = `当前筛选结果（${actualCount}条）`;
        } else {
          rangeText = `全部号码（${actualCount}条）`;
        }
        
        let content = '';
        let fileName = `us-numbers-${new Date().toLocaleDateString()}-${rangeText.replace(/[^\w]/g, '-')}`;
        
        if (exportFormat === 'csv') {
          fileName += '.csv';
          
          // 生成CSV标题行
          const headers = [];
          if (exportPhone) headers.push('phoneNumber');
          if (exportName) headers.push('name');
          if (exportAge) headers.push('age');
          if (exportAssignee) headers.push('assignee');
          if (exportImportTime) headers.push('importTime');
          if (exportFileName) headers.push('fileName');
          content += headers.join(',') + '\n';
          
          // 生成CSV数据行
          exportData.forEach(item => {
            const fields = [];
            if (exportPhone) fields.push(item.phoneNumber);
            if (exportName) fields.push(item.name);
            if (exportAge) fields.push(item.age);
            if (exportAssignee) fields.push(item.assignee || '');
            if (exportImportTime) fields.push(item.importTime);
            if (exportFileName) fields.push(item.fileName || '');
            content += fields.join(',') + '\n';
          });
        } else {
          // TXT格式
          fileName += '.txt';
          exportData.forEach((item, index) => {
            let line = `${index + 1}. `;
            const parts = [];
            if (exportPhone) parts.push(`号码: ${item.phoneNumber}`);
            if (exportName) parts.push(`姓名: ${item.name}`);
            if (exportAge) parts.push(`年龄: ${item.age}`);
            if (exportAssignee) parts.push(`被分配人: ${item.assignee || '未分配'}`);
            if (exportImportTime) parts.push(`导入时间: ${item.importTime}`);
            if (exportFileName) parts.push(`来源文件: ${item.fileName || '手动添加'}`);
            line += parts.join(' | ');
            content += line + '\n';
          });
        }
        
        // 如果选择了在导出时分配目标，则执行分配并记录日志（仅对未分配的号码生效）
        if (exportAssignTo) {
          // 找到对应人员显示名（如果是 displayName 直接匹配即可）
          const assignToDisplay = exportAssignTo;
          // 更新数据源中对应号码的 assignee 字段并写日志
          exportData.forEach(item => {
            const idx = numberList.findIndex(n => n.id === item.id);
            if (idx !== -1 && !numberList[idx].assignee) {
              numberList[idx].assignee = assignToDisplay;
              // 添加日志记录
              addLog(numberList[idx].id, '导出并分配', `导出时分配给 "${assignToDisplay}"（姓名：${numberList[idx].name}，年龄：${numberList[idx].age}）`, 'used');
            }
          });
          // 保存变更
          saveNumbersToStorage();
          // 重新生成导出内容中被分配人的显示（如果需要）
        }

        // 创建并下载文件
        const blob = new Blob([content], { type: exportFormat === 'csv' ? 'text/csv;charset=utf-8;' : 'text/plain;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast(`导出成功，共${actualCount}条数据`, "success");
        closeExportModal();
        hideLoading();
      }, 800);
    }

    // 获取当前筛选后的数据
    function getCurrentFilteredData() {
      const statusFilter = document.getElementById('statusFilter').value;
      const assigneeFilter = document.getElementById('assigneeFilter').value;
      const searchKeyword = document.getElementById('searchInput').value.toLowerCase();

      return numberList.filter(item => {
        if (statusFilter === 'used' && !item.assignee) return false;
        if (statusFilter === 'unused' && item.assignee) return false;
        
        if (assigneeFilter && item.assignee !== assigneeFilter) return false;
        
        if (searchKeyword && !(
          item.phoneNumber.toLowerCase().includes(searchKeyword) || 
          item.name.toLowerCase().includes(searchKeyword) ||
          (item.assignee && item.assignee.toLowerCase().includes(searchKeyword))
        )) return false;
        
        return true;
      });
    }

    // 对 getCurrentFilteredData 的结果进行排序并返回新数组
    function getSortedFilteredData() {
      const arr = getCurrentFilteredData();
      if (!sortField || sortField === '') return arr.slice();

      const sorted = arr.slice().sort((a, b) => {
        const cmp = compareByField(a, b, sortField);
        return sortDirection === 'asc' ? cmp : -cmp;
      });

      return sorted;
    }

    // 人员管理相关函数
    function renderPersonList(filteredData = null) {
      const data = filteredData || personList;
      const container = document.getElementById('personListContainer');
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: #909399;">
            暂无人员数据，请点击"新增人员"添加
          </div>
        `;
      } else {
        data.forEach(person => {
          const card = document.createElement('div');
          card.className = 'person-card';
          
          card.innerHTML = `
            <div class="person-name">
              <span>${person.name}</span>
              <div>
                <button class="btn btn-sm btn-default" onclick="editPerson(${person.id})">
                  <i class="fa fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deletePerson(${person.id})">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="person-info">用途：${person.purpose || '未设置'}</div>
            <div class="person-info">显示名：${person.displayName}</div>
            ${person.remark ? `<div class="person-info">备注：${person.remark}</div>` : ''}
            <div class="person-info">关联号码：${getPersonNumberCount(person.id)}</div>
          `;
          
          container.appendChild(card);
        });
      }
    }

    // 获取人员关联的号码数量
    function getPersonNumberCount(personId) {
      const person = personList.find(p => p.id === personId);
      if (!person) return 0;
      
      return numberList.filter(num => num.assignee === person.displayName).length;
    }

    // 筛选人员
    function filterPersons() {
      const searchKeyword = document.getElementById('personSearchInput').value.toLowerCase();

      const filtered = personList.filter(person => {
        return person.name.toLowerCase().includes(searchKeyword) ||
               (person.purpose && person.purpose.toLowerCase().includes(searchKeyword)) ||
               (person.remark && person.remark.toLowerCase().includes(searchKeyword)) ||
               person.displayName.toLowerCase().includes(searchKeyword);
      });

      renderPersonList(filtered);
    }

    // 显示新增人员表单
    function showAddPersonForm() {
      document.getElementById('personFormTitle').textContent = '新增人员';
      document.getElementById('personForm').reset();
      document.getElementById('personId').value = '';
      document.getElementById('personFormCard').style.display = 'block';
      // 滚动到表单位置
      const card = document.getElementById('personFormCard');
      if (card && typeof card.scrollIntoView === 'function') {
        card.scrollIntoView({ behavior: 'smooth' });
      }
    }

    // 编辑人员
    function editPerson(id) {
      const person = personList.find(p => p.id === id);
      if (person) {
        document.getElementById('personFormTitle').textContent = '编辑人员';
        document.getElementById('personId').value = person.id;
        document.getElementById('personName').value = person.name;
        document.getElementById('personPurpose').value = person.purpose;
        document.getElementById('personRemark').value = person.remark;
        document.getElementById('personFormCard').style.display = 'block';
        // 滚动到表单位置（仅在环境支持时）
        const card = document.getElementById('personFormCard');
        if (card && typeof card.scrollIntoView === 'function') {
          card.scrollIntoView({ behavior: 'smooth' });
        }
      }
    }

    // 隐藏人员表单
    function hidePersonForm() {
      document.getElementById('personFormCard').style.display = 'none';
    }

    // 保存人员
    function savePerson(event) {
      event.preventDefault();
      
      const id = document.getElementById('personId').value;
      const name = document.getElementById('personName').value.trim();
      const purpose = document.getElementById('personPurpose').value.trim();
      const remark = document.getElementById('personRemark').value.trim();
      
      if (!name) {
        showToast("请输入人员姓名", "error");
        return;
      }
      
      // 生成显示名
      const displayName = purpose ? `${name}（${purpose}）` : name;
      
      showLoading("保存中...");
      
      setTimeout(() => { // 模拟网络延迟
        if (id) {
          // 更新现有人员
          const index = personList.findIndex(p => p.id === parseInt(id));
          if (index !== -1) {
            const oldDisplayName = personList[index].displayName;
            personList[index] = {
              ...personList[index],
              name,
              purpose,
              remark,
              displayName
            };
            
            // 如果显示名变了，更新相关号码的被分配人
            if (oldDisplayName !== displayName) {
              numberList.forEach(num => {
                if (num.assignee === oldDisplayName) {
                  num.assignee = displayName;
                  // 添加日志记录
                  addLog(num.id, '人员信息更新', `被分配人名称从 "${oldDisplayName}" 变更为 "${displayName}"`, num.assignee ? 'used' : 'unused');
                }
              });
              saveNumbersToStorage();
            }
            
            showToast('人员信息更新成功', "success");
          }
        } else {
          // 新增人员
          const newId = personList.length > 0 
            ? Math.max(...personList.map(p => p.id)) + 1 
            : 1;
            
          personList.push({
            id: newId,
            name,
            purpose,
            remark,
            displayName
          });
          
          showToast(`人员 "${displayName}" 新增成功`, "success");
        }
        
        // 保存数据并刷新列表
        savePersonsToStorage();
        renderPersonList();
        hidePersonForm();
        hideLoading();
      }, 500);
    }

    // 删除人员
    function deletePerson(id) {
      const person = personList.find(p => p.id === id);
      if (!person) return;
      
      // 检查是否有关联的号码
      const relatedNumbers = numberList.filter(num => num.assignee === person.displayName).length;
      if (relatedNumbers > 0) {
        if (!confirm(`该人员 "${person.displayName}" 关联了 ${relatedNumbers} 个号码，删除后这些号码将变为未分配状态，是否继续？`)) {
          return;
        }
      } else {
        if (!confirm(`确定要删除人员 "${person.displayName}" 吗？`)) {
          return;
        }
      }
      
      showLoading("删除中...");
      
      setTimeout(() => { // 模拟网络延迟
        const index = personList.findIndex(p => p.id === id);
        if (index !== -1) {
          // 更新关联号码
          if (relatedNumbers > 0) {
            numberList.forEach(num => {
              if (num.assignee === person.displayName) {
                num.assignee = "";
                // 添加日志记录
                addLog(num.id, '解除分配', `原被分配人 "${person.displayName}" 已删除，自动解除分配`, 'unused');
              }
            });
            saveNumbersToStorage();
          }
          
          // 删除人员
          personList.splice(index, 1);
          savePersonsToStorage();
          
          renderPersonList();
          renderNumberList(); // 刷新号码列表，显示更新后的分配状态
          showToast(`人员 "${person.displayName}" 已删除`, "success");
        }
        hideLoading();
      }, 500);
    }

    // 提示框和加载动画控制
    function showToast(message, type = "info") {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast'; // 重置样式
      toast.classList.add('show', `toast-${type}`);
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function showLoading(text = "处理中...") {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loading').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
    }
  </script>
</body>
</html>
