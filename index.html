<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¾å›½å·ç æ•°æ®åº“</title>
  <style>
    /* å…¨å±€åŸºç¡€æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial Rounded MT Bold', 'å¾®è½¯é›…é»‘', sans-serif;
    }
    body {
      background-color: #f9fafb;
      padding: 20px;
      color: #1f2937;
      line-height: 1.5;
    }
    .page {
      display: none;
    }
    .page.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* å¡ç‰‡ä¸å®¹å™¨ */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
      padding: 20px;
      margin-bottom: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .section-title {
      font-size: 16px;
      margin-bottom: 15px;
      color: #303133;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
      padding: 7px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn-primary {
      background-color: #409eff;
      color: white;
    }
    .btn-success {
      background-color: #67c23a;
      color: white;
    }
    .btn-default {
      background-color: #f5f7fa;
      color: #606266;
    }
    .btn-danger {
      background-color: #f56c6c;
      color: white;
    }
    .btn-sm {
      padding: 4px 10px;
      font-size: 12px;
    }

    /* è¾“å…¥æ¡†ä¸é€‰æ‹©å™¨ */
    .input, .select {
      padding: 7px 12px;
      border-radius: 8px;
      border: 1px solid #e4e7ed;
      font-size: 14px;
      width: 100%;
      transition: border 0.2s;
    }
    .input:focus, .select:focus {
      border-color: #409eff;
      outline: none;
      box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
    }
    .input-search {
      flex: 1;
      max-width: 400px;
    }
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    .form-col {
      flex: 1;
    }
    @media (max-width: 992px) {
      .form-row {
        flex-wrap: wrap;
        gap: 10px;
      }
      .form-col {
        flex: 0 0 48%;
      }
    }
    @media (max-width: 768px) {
      .form-col {
        flex: 0 0 100%;
      }
    }

    /* é¡¶éƒ¨å¯¼èˆª */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f2f5;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 22px;
      font-weight: bold;
      color: #409eff;
    }
    .logo-icon {
      width: 30px;
      height: 30px;
      background-color: #409eff;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
    }
    .header-actions {
      display: flex;
      gap: 10px;
    }
    .main-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    /* ç­›é€‰åŒº */
    .filter-bar {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    /* è¡¨æ ¼æ ·å¼ */
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .table th, .table td {
      padding: 12px 15px;
      text-align: center;
      border-bottom: 1px solid #f0f2f5;
      white-space: nowrap;
    }
    .table th {
      background-color: #f5f7fa;
      font-weight: 600;
      color: #303133;
    }
    .table th:hover {
      background-color: #eef3fa;
    }
    .table tr:hover {
      background-color: #ecf5ff;
    }
    .phone-number {
      font-family: 'Courier New', Courier, monospace;
      color: #303133;
    }
    .table-container {
      overflow-x: auto;
    }

    /* çŠ¶æ€æ ·å¼ */
    .status-used {
      color: #67c23a;
      font-weight: 500;
    }
    .status-used::before {
      content: "â—";
      margin-right: 5px;
      font-size: 16px;
    }
    .status-unused {
      color: #909399;
    }
    .status-unused::before {
      content: "â—";
      margin-right: 5px;
      font-size: 16px;
    }

    /* æ“ä½œæŒ‰é’® */
    .oper-btn {
      color: #409eff;
      background: none;
      border: none;
      cursor: pointer;
      margin: 0 5px;
      font-size: 14px;
      padding: 2px 4px;
      border-radius: 4px;
    }
    .oper-btn:hover {
      background-color: #ecf5ff;
    }
    .oper-btn-danger {
      color: #f56c6c;
    }
    .oper-btn-danger:hover {
      background-color: #fef0f0;
    }

    /* ç»Ÿè®¡ä¿¡æ¯ */
    .stats {
      margin-bottom: 15px;
      color: #606266;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .stats span {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .stats-used {
      background-color: #f0f9eb;
      color: #67c23a;
    }
    .stats-unused {
      background-color: #f5f7fa;
      color: #909399;
    }

    /* è¡¨å•æ ·å¼ */
    .form {
      max-width: 800px;
      margin: 0 auto;
    }
    .form-item {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #303133;
    }
    .form-hint {
      margin-top: 5px;
      font-size: 12px;
      color: #909399;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 30px;
    }
    .form-note {
      color: #f56c6c;
      font-size: 12px;
      margin-top: 5px;
    }

    /* æ—¶é—´çº¿æ ·å¼ */
    .timeline {
      position: relative;
      max-width: 800px;
      margin: 0 auto;
      padding-left: 30px;
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: #e4e7ed;
    }
    .timeline-item {
      position: relative;
      margin-bottom: 30px;
    }
    .timeline-dot {
      position: absolute;
      left: -30px;
      top: 3px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #409eff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 10px;
    }
    .timeline-dot.used {
      background-color: #67c23a;
    }
    .timeline-dot.unused {
      background-color: #909399;
    }
    .timeline-content {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      border: 1px solid #f0f2f5;
    }
    .timeline-time {
      color: #909399;
      font-size: 12px;
      margin-bottom: 5px;
    }
    .timeline-title {
      font-weight: 500;
      margin-bottom: 8px;
    }
    .timeline-detail {
      font-size: 14px;
      color: #606266;
    }

    /* æç¤ºæ¡†å’ŒåŠ è½½åŠ¨ç”» */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 20px;
      border-radius: 8px;
      background-color: rgba(0,0,0,0.8);
      color: white;
      font-size: 14px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .toast.show {
      opacity: 1;
    }
    .toast-success {
      background-color: rgba(103, 194, 58, 0.9);
    }
    .toast-error {
      background-color: rgba(245, 108, 108, 0.9);
    }
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      z-index: 1001;
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 15px;
    }
    .loading.show {
      display: flex;
    }
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f0f2f5;
      border-top: 4px solid #409eff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* æ‰¹é‡æ“ä½œæ¨¡æ€æ¡† */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
    }
    .modal-backdrop.show {
      display: flex;
    }
    .modal {
      background-color: white;
      border-radius: 12px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid #f0f2f5;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-size: 16px;
      font-weight: 600;
      color: #303133;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #909399;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-close:hover {
      background-color: #f5f7fa;
      color: #606266;
    }
    .modal-body {
      padding: 20px;
    }
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #f0f2f5;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* å¯¼å…¥æ¨¡æ¿å’Œå¸®åŠ©æ–‡æœ¬ */
    .import-template {
      margin-top: 15px;
      padding: 10px;
      background-color: #f5f7fa;
      border-radius: 8px;
      font-size: 13px;
    }
    .import-template-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: #409eff;
    }
    .import-fields {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .import-field {
      padding: 3px 8px;
      background-color: #ecf5ff;
      border-radius: 4px;
      font-size: 12px;
      color: #409eff;
    }

    /* äººå‘˜åˆ—è¡¨æ ·å¼ */
    .person-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .person-card {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #f0f2f5;
      transition: all 0.2s;
    }
    .person-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.05);
      border-color: #e6f7ff;
    }
    .person-name {
      font-weight: 600;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .person-info {
      font-size: 13px;
      color: #606266;
      margin-bottom: 3px;
    }
    .person-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 5px;
    }

    /* å“åº”å¼è°ƒæ•´ */
    @media (max-width: 768px) {
      .filter-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      .input-search {
        width: 100%;
        max-width: none;
      }
      .main-nav {
        flex-wrap: wrap;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      .header-actions {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æç¤ºæ¡†ç»„ä»¶ -->
    <div class="toast" id="toast"></div>
    
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <div id="loadingText">å¤„ç†ä¸­...</div>
    </div>

    <!-- æ‰¹é‡å¯¼å…¥æ¨¡æ€æ¡† -->
    <div class="modal-backdrop" id="importModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">æ‰¹é‡å¯¼å…¥å·ç </div>
          <button class="modal-close" onclick="closeImportModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="form-item">
            <label class="form-label">é€‰æ‹©CSVæ–‡ä»¶</label>
            <input type="file" class="input" id="importFile" accept=".csv">
            <div class="form-hint">æ”¯æŒæ ¼å¼ï¼š.csvï¼Œæœ€å¤§1000æ¡æ•°æ®</div>
          </div>
          
          <div class="form-item">
            <label class="form-label">é»˜è®¤è¢«åˆ†é…äººï¼ˆå¯é€‰ï¼‰</label>
            <select class="select" id="defaultAssignee">
              <option value="">ä¸è®¾ç½®é»˜è®¤å€¼</option>
              <!-- äººå‘˜åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
            </select>
            <div class="form-hint">å¦‚CSVæ–‡ä»¶ä¸­æœªæŒ‡å®šè¢«åˆ†é…äººï¼Œå°†ä½¿ç”¨æ­¤é»˜è®¤å€¼</div>
          </div>
          
          <div class="import-template">
            <div class="import-template-title">
              <i class="fa fa-info-circle"></i> å¯¼å…¥æ ¼å¼è¯´æ˜
            </div>
            <div>æ”¯æŒçš„å­—æ®µï¼ˆé¡ºåºå¿…é¡»ä¸€è‡´ï¼‰ï¼š</div>
            <div class="import-fields">
              <span class="import-field">phoneNumberï¼ˆå¿…å¡«ï¼‰</span>
              <span class="import-field">nameï¼ˆå¿…å¡«ï¼‰</span>
              <span class="import-field">ageï¼ˆå¿…å¡«ï¼‰</span>
              <span class="import-field">assigneeï¼ˆå¯é€‰ï¼‰</span>
            </div>
            <div>ç¤ºä¾‹ï¼š+1-212-555-1234,å¼ ä¸‰,30,äºšé©¬é€Šå›¢é˜Ÿ</div>
            <button class="btn btn-sm btn-default" style="margin-top: 10px;" onclick="downloadImportTemplate()">
              <i class="fa fa-download"></i> ä¸‹è½½æ¨¡æ¿
            </button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" onclick="closeImportModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="doImport()">å¼€å§‹å¯¼å…¥</button>
        </div>
      </div>
    </div>

    <!-- æ‰¹é‡å¯¼å‡ºæ¨¡æ€æ¡† -->
    <div class="modal-backdrop" id="exportModal">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">æ‰¹é‡å¯¼å‡ºå·ç </div>
          <button class="modal-close" onclick="closeExportModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="form-item">
            <label class="form-label">é€‰æ‹©å¯¼å‡ºå­—æ®µ</label>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportPhone"> ç¾å›½å·ç 
              </label>
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportName"> å§“å
              </label>
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportAge"> å¹´é¾„
              </label>
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportAssignee"> è¢«åˆ†é…äºº
              </label>
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportImportTime"> å¯¼å…¥æ—¶é—´
              </label>
              <label style="display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" checked id="exportFileName"> å¯¼å…¥æ–‡ä»¶å
              </label>
            </div>
          </div>
          
          <div class="form-item">
            <label class="form-label">å¯¼å‡ºèŒƒå›´</label>
            <select class="select" id="exportRange">
              <option value="filtered">å½“å‰ç­›é€‰ç»“æœ</option>
              <option value="all">å…¨éƒ¨å·ç </option>
            </select>
          </div>
          
          <div class="form-item">
            <label class="form-label">å¯¼å‡ºæ ¼å¼</label>
            <select class="select" id="exportFormat">
              <option value="csv">CSVï¼ˆæ¨èï¼‰</option>
              <option value="txt">TXTï¼ˆæ¯è¡Œä¸€æ¡è®°å½•ï¼‰</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-default" onclick="closeExportModal()">å–æ¶ˆ</button>
          <button class="btn btn-primary" onclick="doExport()">å¼€å§‹å¯¼å‡º</button>
        </div>
      </div>
    </div>

    <!-- 1. å·ç åˆ—è¡¨é¡µ -->
    <div class="page active" id="listPage">
      <!-- é¡¶éƒ¨å¯¼èˆª -->
      <div class="header">
        <div class="logo">
          <div class="logo-icon">ğŸ“</div>
          USå·ç ç®¡å®¶
        </div>
        <div class="header-actions">
          <button class="btn btn-success" onclick="showAddForm()">
            â• æ–°å¢å·ç 
          </button>
          <button class="btn btn-primary" onclick="openImportModal()">
            ğŸ“¥ æ‰¹é‡å¯¼å…¥
          </button>
          <button class="btn btn-primary" onclick="openExportModal()">
            ğŸ“¤ æ‰¹é‡å¯¼å‡º
          </button>
          <button class="btn btn-default" onclick="refreshList()">
            ğŸ”„ åˆ·æ–°
          </button>
        </div>
      </div>

      <!-- ä¸»å¯¼èˆª -->
      <div class="main-nav">
        <button class="btn btn-primary" onclick="showPage('listPage')">
          ğŸ“‹ å·ç ç®¡ç†
        </button>
        <button class="btn btn-default" onclick="showPage('personPage')">
          ğŸ‘¥ äººå‘˜ç®¡ç†
        </button>
      </div>

      <!-- ç­›é€‰åŒº -->
      <div class="card">
        <div class="filter-bar">
          <select class="select" id="statusFilter" onchange="filterNumbers()">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="used">å·²ä½¿ç”¨ï¼ˆæœ‰åˆ†é…äººï¼‰</option>
            <option value="unused">æœªä½¿ç”¨ï¼ˆæ— åˆ†é…äººï¼‰</option>
          </select>

          <select class="select" id="assigneeFilter" onchange="filterNumbers()">
            <option value="">å…¨éƒ¨äººå‘˜</option>
            <!-- äººå‘˜åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
          </select>

          <input type="text" class="input input-search" id="searchInput" 
                 placeholder="æœç´¢å·ç /å§“å/è¢«åˆ†é…äºº" oninput="filterNumbers()">
        </div>
      </div>

      <!-- å·ç è¡¨æ ¼ -->
      <div class="card">
        <div class="stats">
          å…± <span id="totalCount">0</span> æ¡ 
          <span class="stats-used" id="usedCount">å·²ä½¿ç”¨ 0 æ¡</span>
          <span class="stats-unused" id="unusedCount">æœªä½¿ç”¨ 0 æ¡</span>
        </div>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>åºå·</th>
                <th>ç¾å›½å·ç </th>
                <th>å§“å</th>
                <th>å¹´é¾„</th>
                <th>è¢«åˆ†é…äºº</th>
                <th>å¯¼å…¥æ—¶é—´</th>
                <th>å¯¼å…¥æ–‡ä»¶å</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="numberTableBody">
              <!-- è¡¨æ ¼å†…å®¹ç”±JSåŠ¨æ€ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 2. ç¼–è¾‘/æ–°å¢å·ç é¡µ -->
    <div class="page" id="editPage">
      <div class="header">
        <button class="btn btn-default" onclick="returnToList()">
          â† è¿”å›åˆ—è¡¨
        </button>
        <h2 id="editTitle">ç¼–è¾‘å·ç </h2>
      </div>

      <div class="card">
        <form class="form" id="editForm" onsubmit="saveNumber(event)">
          <input type="hidden" id="editId"> <!-- éšè—çš„IDå­—æ®µ -->
          <input type="hidden" id="editFileName"> <!-- å¯¼å…¥æ–‡ä»¶åï¼ˆä»…å¯¼å…¥æ—¶è®¾ç½®ï¼‰ -->

          <div class="form-row">
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">ç¾å›½å·ç  <span style="color: #f56c6c;">*</span></label>
                <input type="text" class="input" id="editPhone" placeholder="+1-XXX-XXX-XXXX" 
                      pattern="^\+1-\d{3}-\d{3}-\d{4}$" required>
                <div class="form-hint">è¯·è¾“å…¥ç¾å›½å·ç ï¼Œæ ¼å¼ï¼š+1-XXX-XXX-XXXX</div>
              </div>
            </div>
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">å§“å <span style="color: #f56c6c;">*</span></label>
                <input type="text" class="input" id="editName" placeholder="è¯·è¾“å…¥å§“å" required>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">å¹´é¾„ <span style="color: #f56c6c;">*</span></label>
                <input type="number" class="input" id="editAge" placeholder="è¯·è¾“å…¥å¹´é¾„" min="0" max="150" required>
                <div class="form-hint">è¯·è¾“å…¥æœ‰æ•ˆçš„å¹´é¾„ï¼ˆ0-150ï¼‰</div>
              </div>
            </div>
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">è¢«åˆ†é…äºº</label>
                <select class="select" id="editAssigneeSelect">
                  <option value="">æœªåˆ†é…</option>
                  <!-- äººå‘˜åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </select>
                <div style="display: flex; gap: 10px; margin-top: 8px;">
                  <input type="text" class="input" id="editAssigneeText" placeholder="æˆ–ç›´æ¥è¾“å…¥">
                  <button type="button" class="btn btn-sm btn-default" onclick="addPersonFromEdit()">
                    + æ·»åŠ 
                  </button>
                </div>
                <div class="form-hint">ä»å·²æœ‰äººå‘˜é€‰æ‹©æˆ–ç›´æ¥è¾“å…¥æ–°äººå‘˜</div>
              </div>
            </div>
          </div>

          <div class="form-item" id="importFileNameContainer" style="display: none;">
            <label class="form-label">å¯¼å…¥æ–‡ä»¶å</label>
            <input type="text" class="input" id="editDisplayFileName" disabled>
            <div class="form-hint">è¯¥å­—æ®µç”±ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œä¸å¯ä¿®æ”¹</div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-default" onclick="returnToList()">
              å–æ¶ˆ
            </button>
            <button type="submit" class="btn btn-primary">
              ä¿å­˜
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- 3. ä½¿ç”¨è®°å½•é¡µ -->
    <div class="page" id="logPage">
      <div class="header">
        <button class="btn btn-default" onclick="returnToList()">
          â† è¿”å›åˆ—è¡¨
        </button>
        <h2 id="logTitle">å·ç ä½¿ç”¨è®°å½•</h2>
      </div>

      <div class="card">
        <div id="logPhone" class="form-hint" style="margin-bottom: 20px; font-size: 14px;"></div>
        
        <div class="timeline" id="timelineContainer">
          <!-- æ—¶é—´çº¿å†…å®¹ç”±JSåŠ¨æ€ç”Ÿæˆ -->
          <div class="timeline-item">
            <div class="timeline-dot">â„¹ï¸</div>
            <div class="timeline-content">
              <div class="timeline-time">è¯·é€‰æ‹©ä¸€ä¸ªå·ç æŸ¥çœ‹è®°å½•</div>
              <div class="timeline-title">ä½¿ç”¨è®°å½•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
              <div class="timeline-detail">åŒ…æ‹¬å·ç çš„åˆ†é…ã€ä¿®æ”¹å’ŒçŠ¶æ€å˜æ›´å†å²</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 4. äººå‘˜ç®¡ç†é¡µ -->
    <div class="page" id="personPage">
      <div class="header">
        <button class="btn btn-default" onclick="returnToList()">
          â† è¿”å›å·ç ç®¡ç†
        </button>
        <h2>äººå‘˜ç®¡ç†</h2>
      </div>

      <div class="card">
        <div class="filter-bar">
          <input type="text" class="input input-search" id="personSearchInput" 
                 placeholder="æœç´¢äººå‘˜å§“å/ç”¨é€”" oninput="filterPersons()">
          <button class="btn btn-success" onclick="showAddPersonForm()">
            â• æ–°å¢äººå‘˜
          </button>
        </div>
      </div>

      <div class="card">
        <div class="section-title">
          <i class="fa fa-users"></i> äººå‘˜åˆ—è¡¨
        </div>
        <div id="personListContainer" class="person-list">
          <!-- äººå‘˜åˆ—è¡¨ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
      </div>

      <!-- æ–°å¢/ç¼–è¾‘äººå‘˜è¡¨å• -->
      <div class="card" id="personFormCard" style="display: none;">
        <div class="section-title">
          <i class="fa fa-user"></i> <span id="personFormTitle">æ–°å¢äººå‘˜</span>
        </div>
        <form class="form" id="personForm" onsubmit="savePerson(event)">
          <input type="hidden" id="personId">

          <div class="form-row">
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">å§“å <span style="color: #f56c6c;">*</span></label>
                <input type="text" class="input" id="personName" placeholder="è¯·è¾“å…¥äººå‘˜å§“å" required>
              </div>
            </div>
            <div class="form-col">
              <div class="form-item">
                <label class="form-label">ç”¨é€”/éƒ¨é—¨</label>
                <input type="text" class="input" id="personPurpose" placeholder="å¦‚ï¼šäºšé©¬é€Šã€å®¢æœéƒ¨">
                <div class="form-hint">ç”¨äºåŒºåˆ†åŒä¸€å§“åçš„ä¸åŒç”¨é€”</div>
              </div>
            </div>
          </div>

          <div class="form-item">
            <label class="form-label">å¤‡æ³¨</label>
            <textarea class="input" style="min-height:80px;" id="personRemark" placeholder="æ·»åŠ äººå‘˜ç›¸å…³å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-default" onclick="hidePersonForm()">
              å–æ¶ˆ
            </button>
            <button type="submit" class="btn btn-primary">
              ä¿å­˜
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€æ•°æ®å­˜å‚¨
    let numberList = [];    // å·ç åˆ—è¡¨
    let logList = [];       // æ“ä½œæ—¥å¿—
    let personList = [];    // äººå‘˜åˆ—è¡¨
    let currentNumberId = null;
    let currentPersonId = null;

    // åˆå§‹åŒ–é¡µé¢
    window.onload = function() {
      showLoading("åŠ è½½æ•°æ®ä¸­...");
      // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
      loadAllData();
      // æ¸²æŸ“åˆ—è¡¨
      renderNumberList();
      renderPersonList();
      updatePersonSelectors();
      hideLoading();
    };

    // é¡µé¢åˆ‡æ¢ - è¿”å›åˆ—è¡¨é¡µ
    function returnToList() {
      showToast("è¿”å›åˆ—è¡¨", "success");
      document.getElementById('listPage').classList.add('active');
      document.getElementById('editPage').classList.remove('active');
      document.getElementById('logPage').classList.remove('active');
      document.getElementById('personPage').classList.remove('active');
    }

    // é€šç”¨é¡µé¢åˆ‡æ¢
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      document.getElementById(pageId).classList.add('active');
      
      // å¦‚æœåˆ‡æ¢åˆ°äººå‘˜é¡µé¢ï¼Œé‡æ–°æ¸²æŸ“äººå‘˜åˆ—è¡¨
      if (pageId === 'personPage') {
        renderPersonList();
      }
    }

    // åŠ è½½æ‰€æœ‰æ•°æ®
    function loadAllData() {
      // ä»æœ¬åœ°å­˜å‚¨è·å–ï¼Œæ²¡æœ‰åˆ™åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®
      const savedNumbers = localStorage.getItem('usNumbers');
      const savedLogs = localStorage.getItem('usLogs');
      const savedPersons = localStorage.getItem('usPersons');

      // åŠ è½½å·ç æ•°æ®
      if (savedNumbers) {
        numberList = JSON.parse(savedNumbers);
      } else {
        // åˆå§‹åŒ–ç¤ºä¾‹æ•°æ®ï¼ˆåŒ…å«æ‰€æœ‰è¦æ±‚çš„å­—æ®µï¼‰
        numberList = [
          { 
            id: 1, 
            phoneNumber: "+1-212-555-1234", 
            name: "å¼ ä¸‰",
            age: 30,
            assignee: "äºšé©¬é€Šå›¢é˜Ÿ", 
            importTime: "2024-09-20 15:30",
            fileName: "initial_data.csv"
          },
          { 
            id: 2, 
            phoneNumber: "+1-310-555-6789", 
            name: "æå››",
            age: 28,
            assignee: "", 
            importTime: "2024-09-21 10:15",
            fileName: "initial_data.csv"
          },
          { 
            id: 3, 
            phoneNumber: "+1-773-555-4321", 
            name: "ç‹äº”",
            age: 35,
            assignee: "Shopifyå›¢é˜Ÿ", 
            importTime: "2024-09-21 14:00",
            fileName: "october_batch.csv"
          },
          { 
            id: 4, 
            phoneNumber: "+1-415-555-9876", 
            name: "èµµå…­",
            age: 25,
            assignee: "", 
            importTime: "2024-09-22 09:45",
            fileName: "october_batch.csv"
          }
        ];
        saveNumbersToStorage();
      }

      // åŠ è½½æ—¥å¿—æ•°æ®
      if (savedLogs) {
        logList = JSON.parse(savedLogs);
      } else {
        logList = [
          { id: 1, numberId: 1, action: "åˆ†é…", content: "åˆ†é…ç»™ äºšé©¬é€Šå›¢é˜Ÿ", time: "2024-09-20 15:30", type: "used" },
          { id: 2, numberId: 3, action: "åˆ†é…", content: "åˆ†é…ç»™ Shopifyå›¢é˜Ÿ", time: "2024-09-21 14:00", type: "used" }
        ];
        saveLogsToStorage();
      }

      // åŠ è½½äººå‘˜æ•°æ®
      if (savedPersons) {
        personList = JSON.parse(savedPersons);
      } else {
        personList = [
          { id: 1, name: "äºšé©¬é€Šå›¢é˜Ÿ", purpose: "ç”µå•†å¹³å°", remark: "è´Ÿè´£äºšé©¬é€Šç›¸å…³ä¸šåŠ¡", displayName: "äºšé©¬é€Šå›¢é˜Ÿ" },
          { id: 2, name: "Shopifyå›¢é˜Ÿ", purpose: "ç”µå•†å¹³å°", remark: "è´Ÿè´£Shopifyç›¸å…³ä¸šåŠ¡", displayName: "Shopifyå›¢é˜Ÿ" },
          { id: 3, name: "å®¢æœéƒ¨", purpose: "å®¢æˆ·æœåŠ¡", remark: "è´Ÿè´£å®¢æˆ·å’¨è¯¢", displayName: "å®¢æœéƒ¨" }
        ];
        savePersonsToStorage();
      }
    }

    // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    function saveNumbersToStorage() {
      localStorage.setItem('usNumbers', JSON.stringify(numberList));
    }
    function saveLogsToStorage() {
      localStorage.setItem('usLogs', JSON.stringify(logList));
    }
    function savePersonsToStorage() {
      localStorage.setItem('usPersons', JSON.stringify(personList));
      // æ›´æ–°æ‰€æœ‰äººå‘˜é€‰æ‹©å™¨
      updatePersonSelectors();
    }

    // æ›´æ–°æ‰€æœ‰äººå‘˜é€‰æ‹©å™¨
    function updatePersonSelectors() {
      // æ›´æ–°åˆ†é…äººç­›é€‰å™¨
      const assigneeFilter = document.getElementById('assigneeFilter');
      assigneeFilter.innerHTML = '<option value="">å…¨éƒ¨äººå‘˜</option>';
      
      // æ›´æ–°ç¼–è¾‘é¡µçš„äººå‘˜é€‰æ‹©å™¨
      const editAssigneeSelect = document.getElementById('editAssigneeSelect');
      editAssigneeSelect.innerHTML = '<option value="">æœªåˆ†é…</option>';
      
      // æ›´æ–°å¯¼å…¥æ¨¡æ€æ¡†çš„é»˜è®¤åˆ†é…äººé€‰æ‹©å™¨
      const defaultAssignee = document.getElementById('defaultAssignee');
      defaultAssignee.innerHTML = '<option value="">ä¸è®¾ç½®é»˜è®¤å€¼</option>';
      
      // æ·»åŠ äººå‘˜é€‰é¡¹
      personList.forEach(person => {
        // ç­›é€‰å™¨é€‰é¡¹
        const filterOption = document.createElement('option');
        filterOption.value = person.displayName;
        filterOption.textContent = person.displayName;
        assigneeFilter.appendChild(filterOption);
        
        // ç¼–è¾‘é¡µé€‰é¡¹
        const editOption = document.createElement('option');
        editOption.value = person.displayName;
        editOption.textContent = person.displayName;
        editAssigneeSelect.appendChild(editOption);
        
        // å¯¼å…¥æ¨¡æ€æ¡†é€‰é¡¹
        const importOption = document.createElement('option');
        importOption.value = person.displayName;
        importOption.textContent = person.displayName;
        defaultAssignee.appendChild(importOption);
      });
    }

    // æ¸²æŸ“å·ç åˆ—è¡¨
    function renderNumberList(filteredData = null) {
      const data = filteredData || numberList;
      const tableBody = document.getElementById('numberTableBody');
      tableBody.innerHTML = '';

      if (data.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="8" style="padding: 30px;">æš‚æ— å·ç æ•°æ®ï¼Œè¯·ç‚¹å‡»"æ–°å¢å·ç "æˆ–"æ‰¹é‡å¯¼å…¥"æ·»åŠ </td>
          </tr>
        `;
      } else {
        data.forEach((item, index) => {
          const tr = document.createElement('tr');
          
          tr.innerHTML = `
            <td>${index + 1}</td>
            <td class="phone-number">${item.phoneNumber}</td>
            <td>${item.name}</td>
            <td>${item.age}</td>
            <td>
              ${item.assignee 
                ? `<span class="status-used">${item.assignee}</span>` 
                : `<span class="status-unused">æœªåˆ†é…</span>`
              }
            </td>
            <td>${item.importTime}</td>
            <td>${item.fileName || '-'}</td>
            <td>
              <button class="oper-btn" onclick="editNumber(${item.id})">ç¼–è¾‘</button>
              <button class="oper-btn" onclick="viewLog(${item.id})">è®°å½•</button>
              <button class="oper-btn oper-btn-danger" onclick="deleteNumber(${item.id})">åˆ é™¤</button>
            </td>
          `;
          
          tableBody.appendChild(tr);
        });
      }

      // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
      updateStats(data);
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(data) {
      const total = data.length;
      const used = data.filter(item => item.assignee).length;
      const unused = total - used;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('usedCount').textContent = `å·²ä½¿ç”¨ ${used} æ¡`;
      document.getElementById('unusedCount').textContent = `æœªä½¿ç”¨ ${unused} æ¡`;
    }

    // ç­›é€‰å·ç 
    function filterNumbers() {
      const statusFilter = document.getElementById('statusFilter').value;
      const assigneeFilter = document.getElementById('assigneeFilter').value;
      const searchKeyword = document.getElementById('searchInput').value.toLowerCase();

      const filtered = numberList.filter(item => {
        // çŠ¶æ€ç­›é€‰
        if (statusFilter === 'used' && !item.assignee) return false;
        if (statusFilter === 'unused' && item.assignee) return false;
        
        // äººå‘˜ç­›é€‰
        if (assigneeFilter && item.assignee !== assigneeFilter) return false;
        
        // æœç´¢ç­›é€‰
        if (searchKeyword && !(
          item.phoneNumber.toLowerCase().includes(searchKeyword) || 
          item.name.toLowerCase().includes(searchKeyword) ||
          (item.assignee && item.assignee.toLowerCase().includes(searchKeyword))
        )) return false;
        
        return true;
      });

      renderNumberList(filtered);
    }

    // æ˜¾ç¤ºæ–°å¢å·ç è¡¨å•
    function showAddForm() {
      document.getElementById('editTitle').textContent = 'æ–°å¢å·ç ';
      document.getElementById('editForm').reset();
      document.getElementById('editId').value = '';
      document.getElementById('editAssigneeText').value = '';
      document.getElementById('editFileName').value = '';
      document.getElementById('importFileNameContainer').style.display = 'none';
      showPage('editPage');
    }

    // ç¼–è¾‘å·ç 
    function editNumber(id) {
      const item = numberList.find(item => item.id === id);
      if (item) {
        document.getElementById('editTitle').textContent = 'ç¼–è¾‘å·ç ';
        document.getElementById('editId').value = item.id;
        document.getElementById('editPhone').value = item.phoneNumber;
        document.getElementById('editName').value = item.name;
        document.getElementById('editAge').value = item.age;
        document.getElementById('editAssigneeSelect').value = item.assignee || '';
        document.getElementById('editAssigneeText').value = '';
        document.getElementById('editFileName').value = item.fileName || '';
        document.getElementById('editDisplayFileName').value = item.fileName || '';
        
        // æ˜¾ç¤ºå¯¼å…¥æ–‡ä»¶åï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (item.fileName) {
          document.getElementById('importFileNameContainer').style.display = 'block';
        } else {
          document.getElementById('importFileNameContainer').style.display = 'none';
        }
        
        showPage('editPage');
      }
    }

    // ä»ç¼–è¾‘é¡µæ·»åŠ æ–°äººå‘˜
    function addPersonFromEdit() {
      const assigneeText = document.getElementById('editAssigneeText').value.trim();
      if (!assigneeText) {
        showToast("è¯·è¾“å…¥äººå‘˜ä¿¡æ¯", "error");
        return;
      }
      
      // å°è¯•è§£æå§“åå’Œç”¨é€”ï¼ˆæ ¼å¼ï¼šå§“åï¼ˆç”¨é€”ï¼‰ï¼‰
      let name, purpose;
      const match = assigneeText.match(/^(.*?)(?:\((.*)\))?$/);
      if (match) {
        name = match[1].trim();
        purpose = match[2] ? match[2].trim() : '';
      } else {
        name = assigneeText;
        purpose = '';
      }
      
      if (!name) {
        showToast("è¯·è¾“å…¥äººå‘˜å§“å", "error");
        return;
      }
      
      // åˆ›å»ºæ–°äººå‘˜
      const newId = personList.length > 0 
        ? Math.max(...personList.map(p => p.id)) + 1 
        : 1;
      
      const newPerson = {
        id: newId,
        name,
        purpose,
        remark: '',
        displayName: assigneeText
      };
      
      personList.push(newPerson);
      savePersonsToStorage();
      
      // é€‰ä¸­æ–°æ·»åŠ çš„äººå‘˜
      document.getElementById('editAssigneeSelect').value = assigneeText;
      document.getElementById('editAssigneeText').value = '';
      
      showToast(`å·²æ·»åŠ æ–°äººå‘˜ï¼š${assigneeText}`, "success");
    }

    // ä¿å­˜å·ç 
    function saveNumber(event) {
      event.preventDefault();
      
      const id = document.getElementById('editId').value;
      const phoneNumber = document.getElementById('editPhone').value;
      const name = document.getElementById('editName').value.trim();
      const age = parseInt(document.getElementById('editAge').value);
      const assigneeSelect = document.getElementById('editAssigneeSelect').value;
      const assigneeText = document.getElementById('editAssigneeText').value.trim();
      const assignee = assigneeText || assigneeSelect;
      const fileName = document.getElementById('editFileName').value;
      
      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!name) {
        showToast("è¯·è¾“å…¥å§“å", "error");
        return;
      }
      
      if (isNaN(age) || age < 0 || age > 150) {
        showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„å¹´é¾„ï¼ˆ0-150ï¼‰", "error");
        return;
      }
      
      // éªŒè¯å·ç æ ¼å¼
      const phonePattern = /^\+1-\d{3}-\d{3}-\d{4}$/;
      if (!phonePattern.test(phoneNumber)) {
        showToast("è¯·è¾“å…¥æ­£ç¡®çš„ç¾å›½å·ç æ ¼å¼ï¼š+1-XXX-XXX-XXXX", "error");
        return;
      }
      
      // ç”Ÿæˆå½“å‰æ—¶é—´
      const now = new Date();
      const timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
      
      showLoading("ä¿å­˜ä¸­...");
      
      setTimeout(() => { // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        if (id) {
          // æ›´æ–°ç°æœ‰å·ç 
          const index = numberList.findIndex(item => item.id === parseInt(id));
          if (index !== -1) {
            // è®°å½•çŠ¶æ€å˜æ›´
            const oldAssignee = numberList[index].assignee;
            const oldName = numberList[index].name;
            const oldAge = numberList[index].age;
            const oldPhone = numberList[index].phoneNumber;
            
            numberList[index] = {
              ...numberList[index],
              phoneNumber,
              name,
              age,
              assignee,
              fileName, // ä¿ç•™å¯¼å…¥æ–‡ä»¶åä¸å˜
              importTime: numberList[index].importTime // ä¿ç•™åŸå§‹å¯¼å…¥æ—¶é—´
            };
            
            // ç”Ÿæˆæ—¥å¿—å†…å®¹
            let logContent = [];
            if (oldPhone !== phoneNumber) logContent.push(`å·ç ä» "${oldPhone}" å˜æ›´ä¸º "${phoneNumber}"`);
            if (oldName !== name) logContent.push(`å§“åä» "${oldName}" å˜æ›´ä¸º "${name}"`);
            if (oldAge !== age) logContent.push(`å¹´é¾„ä» "${oldAge}" å˜æ›´ä¸º "${age}"`);
            if (oldAssignee !== assignee) logContent.push(`è¢«åˆ†é…äººä» "${oldAssignee || 'æœªåˆ†é…'}" å˜æ›´ä¸º "${assignee || 'æœªåˆ†é…'}"`);
            
            // æ·»åŠ æ—¥å¿—è®°å½•
            addLog(parseInt(id), 'æ›´æ–°', logContent.join('ï¼›'), assignee ? 'used' : 'unused');
            
            showToast('å·ç æ›´æ–°æˆåŠŸ', "success");
          }
        } else {
          // æ£€æŸ¥å·ç æ˜¯å¦å·²å­˜åœ¨
          const exists = numberList.some(item => item.phoneNumber === phoneNumber);
          if (exists) {
            hideLoading();
            showToast("è¯¥å·ç å·²å­˜åœ¨", "error");
            return;
          }
          
          // æ–°å¢å·ç ï¼ˆæ‰‹åŠ¨æ–°å¢çš„æ²¡æœ‰å¯¼å…¥æ–‡ä»¶åï¼‰
          const newId = numberList.length > 0 
            ? Math.max(...numberList.map(item => item.id)) + 1 
            : 1;
            
          numberList.push({
            id: newId,
            phoneNumber,
            name,
            age,
            assignee,
            importTime: timeStr,
            fileName: '' // æ‰‹åŠ¨æ–°å¢çš„æ— å¯¼å…¥æ–‡ä»¶å
          });
          
          // æ·»åŠ æ—¥å¿—è®°å½•
          let logAction = assignee ? 'åˆ†é…' : 'æ–°å¢';
          let logContent = assignee ? `åˆ†é…ç»™ "${assignee}"` : 'æ–°å¢æœªåˆ†é…å·ç ';
          logContent += `ï¼ˆå§“åï¼š${name}ï¼Œå¹´é¾„ï¼š${age}ï¼‰`;
          
          addLog(newId, logAction, logContent, assignee ? 'used' : 'unused');
          
          showToast('å·ç æ–°å¢æˆåŠŸ', "success");
        }
        
        // ä¿å­˜æ•°æ®å¹¶è¿”å›åˆ—è¡¨é¡µ
        saveNumbersToStorage();
        renderNumberList();
        returnToList();
        hideLoading();
      }, 500);
    }

    // æ·»åŠ æ—¥å¿—è®°å½•
    function addLog(numberId, action, content, type) {
      const now = new Date();
      const timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
      
      const newLog = {
        id: logList.length > 0 ? Math.max(...logList.map(log => log.id)) + 1 : 1,
        numberId,
        action,
        content,
        time: timeStr,
        type
      };
      
      logList.push(newLog);
      saveLogsToStorage();
    }

    // æŸ¥çœ‹ä½¿ç”¨è®°å½•
    function viewLog(numberId) {
      currentNumberId = numberId;
      const number = numberList.find(item => item.id === numberId);
      
      if (number) {
        document.getElementById('logTitle').textContent = `å·ç ä½¿ç”¨è®°å½• - ${number.phoneNumber}`;
        document.getElementById('logPhone').textContent = 
          `å·ç ï¼š${number.phoneNumber} | å§“åï¼š${number.name} | å¹´é¾„ï¼š${number.age} | çŠ¶æ€ï¼š${number.assignee ? 'å·²ä½¿ç”¨' : 'æœªä½¿ç”¨'} | è¢«åˆ†é…äººï¼š${number.assignee || 'æ— '}`;
        
        // ç­›é€‰è¯¥å·ç çš„æ—¥å¿—
        const numberLogs = logList.filter(log => log.numberId === numberId)
                                 .sort((a, b) => new Date(b.time) - new Date(a.time));
        
        const timelineContainer = document.getElementById('timelineContainer');
        timelineContainer.innerHTML = '';
        
        if (numberLogs.length === 0) {
          timelineContainer.innerHTML = `
            <div class="timeline-item">
              <div class="timeline-dot">â„¹ï¸</div>
              <div class="timeline-content">
                <div class="timeline-time">æš‚æ— è®°å½•</div>
                <div class="timeline-title">è¯¥å·ç æš‚æ— ä½¿ç”¨è®°å½•</div>
              </div>
            </div>
          `;
        } else {
          numberLogs.forEach(log => {
            const item = document.createElement('div');
            item.className = 'timeline-item';
            
            item.innerHTML = `
              <div class="timeline-dot ${log.type}">
                ${log.type === 'used' ? 'âœ“' : 'â—‹'}
              </div>
              <div class="timeline-content">
                <div class="timeline-time">${log.time}</div>
                <div class="timeline-title">${log.action}æ“ä½œ</div>
                <div class="timeline-detail">${log.content}</div>
              </div>
            `;
            
            timelineContainer.appendChild(item);
          });
        }
        
        showPage('logPage');
      }
    }

    // åˆ é™¤å·ç 
    function deleteNumber(id) {
      const number = numberList.find(item => item.id === id);
      if (!number) return;
      
      if (confirm(`ç¡®å®šè¦åˆ é™¤å·ç  ${number.phoneNumber}ï¼ˆ${number.name}ï¼Œ${number.age}å²ï¼‰å—ï¼Ÿç›¸å…³è®°å½•ä¼šè¢«ä¿ç•™ã€‚`)) {
        showLoading("åˆ é™¤ä¸­...");
        
        setTimeout(() => { // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
          const index = numberList.findIndex(item => item.id === id);
          if (index !== -1) {
            numberList.splice(index, 1);
            saveNumbersToStorage();
            
            // æ·»åŠ åˆ é™¤æ—¥å¿—
            addLog(id, 'åˆ é™¤', `åˆ é™¤å·ç  ${number.phoneNumber}ï¼ˆ${number.name}ï¼Œ${number.age}å²ï¼‰`, 'unused');
            
            renderNumberList();
            showToast('å·ç å·²åˆ é™¤', "success");
          }
          hideLoading();
        }, 500);
      }
    }

    // åˆ·æ–°åˆ—è¡¨
    function refreshList() {
      showLoading("åˆ·æ–°ä¸­...");
      
      setTimeout(() => { // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
        loadAllData();
        renderNumberList();
        renderPersonList();
        showToast('æ•°æ®å·²åˆ·æ–°', "success");
        hideLoading();
      }, 800);
    }

    // æ‰¹é‡å¯¼å…¥ç›¸å…³å‡½æ•°
    function openImportModal() {
      document.getElementById('importFile').value = '';
      document.getElementById('defaultAssignee').value = '';
      document.getElementById('importModal').classList.add('show');
    }

    function closeImportModal() {
      document.getElementById('importModal').classList.remove('show');
    }

    function downloadImportTemplate() {
      const csvContent = "phoneNumber,name,age,assignee\n" +
                        "+1-212-555-1234,å¼ ä¸‰,30,äºšé©¬é€Šå›¢é˜Ÿ\n" +
                        "+1-310-555-6789,æå››,28,Shopifyå›¢é˜Ÿ";
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', 'us-number-import-template.csv');
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('æ¨¡æ¿ä¸‹è½½æˆåŠŸ', "success");
    }

    function doImport() {
      const fileInput = document.getElementById('importFile');
      const defaultAssignee = document.getElementById('defaultAssignee').value;
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast("è¯·é€‰æ‹©è¦å¯¼å…¥çš„CSVæ–‡ä»¶", "error");
        return;
      }
      
      const file = fileInput.files[0];
      if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
        showToast("è¯·é€‰æ‹©CSVæ ¼å¼çš„æ–‡ä»¶", "error");
        return;
      }
      
      showLoading("å¯¼å…¥ä¸­...");
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const content = e.target.result;
          const lines = content.split('\n');
          const importedNumbers = [];
          let successCount = 0;
          let duplicateCount = 0;
          let errorCount = 0;
          
          // ç”Ÿæˆå½“å‰æ—¶é—´
          const now = new Date();
          const timeStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
          
          // å¯¼å…¥æ–‡ä»¶åï¼ˆä»…ä¿ç•™æ–‡ä»¶åï¼Œä¸å«è·¯å¾„ï¼‰
          const fileName = file.name;
          
          // è·³è¿‡æ ‡é¢˜è¡Œï¼Œä»ç¬¬ä¸€è¡Œæ•°æ®å¼€å§‹å¤„ç†
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue; // è·³è¿‡ç©ºè¡Œ
            
            // åˆ†å‰²CSVå­—æ®µ
            const fields = line.split(',');
            if (fields.length < 3) { // è‡³å°‘éœ€è¦phoneNumber, name, ageä¸‰ä¸ªå­—æ®µ
              errorCount++;
              continue;
            }
            
            const phoneNumber = fields[0].trim();
            const name = fields[1].trim();
            const age = parseInt(fields[2].trim());
            let assignee = fields.length > 3 ? fields[3].trim() : '';
            
            // åº”ç”¨é»˜è®¤è¢«åˆ†é…äºº
            if (!assignee && defaultAssignee) {
              assignee = defaultAssignee;
            }
            
            // éªŒè¯å­—æ®µ
            const phonePattern = /^\+1-\d{3}-\d{3}-\d{4}$/;
            if (!phonePattern.test(phoneNumber)) {
              errorCount++;
              continue;
            }
            
            if (!name) {
              errorCount++;
              continue;
            }
            
            if (isNaN(age) || age < 0 || age > 150) {
              errorCount++;
              continue;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const exists = numberList.some(item => item.phoneNumber === phoneNumber);
            if (exists) {
              duplicateCount++;
              continue;
            }
            
            // æ·»åŠ åˆ°å¯¼å…¥åˆ—è¡¨
            importedNumbers.push({
              phoneNumber,
              name,
              age,
              assignee,
              importTime: timeStr,
              fileName: fileName
            });
            
            successCount++;
          }
          
          // ä¿å­˜å¯¼å…¥çš„å·ç 
          if (importedNumbers.length > 0) {
            const newId = numberList.length > 0 
              ? Math.max(...numberList.map(item => item.id)) 
              : 0;
            
            importedNumbers.forEach((num, index) => {
              numberList.push({
                ...num,
                id: newId + index + 1
              });
              
              // æ·»åŠ æ—¥å¿—
              if (num.assignee) {
                addLog(newId + index + 1, 'å¯¼å…¥å¹¶åˆ†é…', 
                      `ä»æ–‡ä»¶ "${fileName}" å¯¼å…¥ï¼Œåˆ†é…ç»™ "${num.assignee}"ï¼ˆå§“åï¼š${num.name}ï¼Œå¹´é¾„ï¼š${num.age}ï¼‰`, 'used');
              } else {
                addLog(newId + index + 1, 'å¯¼å…¥', 
                      `ä»æ–‡ä»¶ "${fileName}" å¯¼å…¥ï¼ˆå§“åï¼š${num.name}ï¼Œå¹´é¾„ï¼š${num.age}ï¼‰`, 'unused');
              }
            });
            
            saveNumbersToStorage();
            renderNumberList();
          }
          
          // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
          showToast(`å¯¼å…¥å®Œæˆï¼šæˆåŠŸ${successCount}æ¡ï¼Œé‡å¤${duplicateCount}æ¡ï¼Œé”™è¯¯${errorCount}æ¡`, "success");
          closeImportModal();
        } catch (error) {
          showToast(`å¯¼å…¥å¤±è´¥ï¼š${error.message}`, "error");
        } finally {
          hideLoading();
        }
      };
      
      reader.readAsText(file);
    }

    // æ‰¹é‡å¯¼å‡ºç›¸å…³å‡½æ•°
    function openExportModal() {
      document.getElementById('exportModal').classList.add('show');
    }

    function closeExportModal() {
      document.getElementById('exportModal').classList.remove('show');
    }

    function doExport() {
      // è·å–å¯¼å‡ºé€‰é¡¹
      const exportPhone = document.getElementById('exportPhone').checked;
      const exportName = document.getElementById('exportName').checked;
      const exportAge = document.getElementById('exportAge').checked;
      const exportAssignee = document.getElementById('exportAssignee').checked;
      const exportImportTime = document.getElementById('exportImportTime').checked;
      const exportFileName = document.getElementById('exportFileName').checked;
      const exportRange = document.getElementById('exportRange').value;
      const exportFormat = document.getElementById('exportFormat').value;
      
      // æ£€æŸ¥æ˜¯å¦è‡³å°‘é€‰æ‹©äº†ä¸€ä¸ªå­—æ®µ
      if (!exportPhone && !exportName && !exportAge && !exportAssignee && !exportImportTime && !exportFileName) {
        showToast("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå¯¼å‡ºå­—æ®µ", "error");
        return;
      }
      
      showLoading("å¯¼å‡ºä¸­...");
      
      setTimeout(() => { // æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿ
        // è·å–è¦å¯¼å‡ºçš„æ•°æ®
        let exportData = exportRange === 'filtered' ? getCurrentFilteredData() : numberList;
        
        if (exportData.length === 0) {
          hideLoading();
          showToast("æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®", "error");
          return;
        }
        
        let content = '';
        let fileName = `us-numbers-${new Date().toLocaleDateString()}`;
        
        if (exportFormat === 'csv') {
          fileName += '.csv';
          
          // ç”ŸæˆCSVæ ‡é¢˜è¡Œ
          const headers = [];
          if (exportPhone) headers.push('phoneNumber');
          if (exportName) headers.push('name');
          if (exportAge) headers.push('age');
          if (exportAssignee) headers.push('assignee');
          if (exportImportTime) headers.push('importTime');
          if (exportFileName) headers.push('fileName');
          content += headers.join(',') + '\n';
          
          // ç”ŸæˆCSVæ•°æ®è¡Œ
          exportData.forEach(item => {
            const fields = [];
            if (exportPhone) fields.push(item.phoneNumber);
            if (exportName) fields.push(item.name);
            if (exportAge) fields.push(item.age);
            if (exportAssignee) fields.push(item.assignee || '');
            if (exportImportTime) fields.push(item.importTime);
            if (exportFileName) fields.push(item.fileName || '');
            content += fields.join(',') + '\n';
          });
        } else {
          // TXTæ ¼å¼
          fileName += '.txt';
          exportData.forEach((item, index) => {
            let line = `${index + 1}. `;
            const parts = [];
            if (exportPhone) parts.push(`å·ç : ${item.phoneNumber}`);
            if (exportName) parts.push(`å§“å: ${item.name}`);
            if (exportAge) parts.push(`å¹´é¾„: ${item.age}`);
            if (exportAssignee) parts.push(`è¢«åˆ†é…äºº: ${item.assignee || 'æœªåˆ†é…'}`);
            if (exportImportTime) parts.push(`å¯¼å…¥æ—¶é—´: ${item.importTime}`);
            if (exportFileName) parts.push(`æ¥æºæ–‡ä»¶: ${item.fileName || 'æ‰‹åŠ¨æ·»åŠ '}`);
            line += parts.join(' | ');
            content += line + '\n';
          });
        }
        
        // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
        const blob = new Blob([content], { type: exportFormat === 'csv' ? 'text/csv;charset=utf-8;' : 'text/plain;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast(`å¯¼å‡ºæˆåŠŸï¼Œå…±${exportData.length}æ¡æ•°æ®`, "success");
        closeExportModal();
        hideLoading();
      }, 800);
    }

    // è·å–å½“å‰ç­›é€‰åçš„æ•°æ®
    function getCurrentFilteredData() {
      const statusFilter = document.getElementById('statusFilter').value;
      const assigneeFilter = document.getElementById('assigneeFilter').value;
      const searchKeyword = document.getElementById('searchInput').value.toLowerCase();

      return numberList.filter(item => {
        if (statusFilter === 'used' && !item.assignee) return false;
        if (statusFilter === 'unused' && item.assignee) return false;
        
        if (assigneeFilter && item.assignee !== assigneeFilter) return false;
        
        if (searchKeyword && !(
          item.phoneNumber.toLowerCase().includes(searchKeyword) || 
          item.name.toLowerCase().includes(searchKeyword) ||
          (item.assignee && item.assignee.toLowerCase().includes(searchKeyword))
        )) return false;
        
        return true;
      });
    }

    // äººå‘˜ç®¡ç†ç›¸å…³å‡½æ•°
    function renderPersonList(filteredData = null) {
      const data = filteredData || personList;
      const container = document.getElementById('personListContainer');
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = `
          <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: #909399;">
            æš‚æ— äººå‘˜æ•°æ®ï¼Œè¯·ç‚¹å‡»"æ–°å¢äººå‘˜"æ·»åŠ 
          </div>
        `;
      } else {
        data.forEach(person => {
          const card = document.createElement('div');
          card.className = 'person-card';
          
          card.innerHTML = `
            <div class="person-name">
              <span>${person.name}</span>
              <div>
                <button class="btn btn-sm btn-default" onclick="editPerson(${person.id})">
                  <i class="fa fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deletePerson(${person.id})">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </div>
            <div class="person-info">ç”¨é€”ï¼š${person.purpose || 'æœªè®¾ç½®'}</div>
            <div class="person-info">æ˜¾ç¤ºåï¼š${person.displayName}</div>
            ${person.remark ? `<div class="person-info">å¤‡æ³¨ï¼š${person.remark}</div>` : ''}
            <div class="person-info">å…³è”å·ç ï¼š${getPersonNumberCount(person.id)}</div>
          `;
          
          container.appendChild(card);
        });
      }
    }

    // è·å–äººå‘˜å…³è”çš„å·ç æ•°é‡
    function getPersonNumberCount(personId) {
      const person = personList.find(p => p.id === personId);
      if (!person) return 0;
      
      return numberList.filter(num => num.assignee === person.displayName).length;
    }

    // ç­›é€‰äººå‘˜
    function filterPersons() {
      const searchKeyword = document.getElementById('personSearchInput').value.toLowerCase();

      const filtered = personList.filter(person => {
        return person.name.toLowerCase().includes(searchKeyword) ||
               (person.purpose && person.purpose.toLowerCase().includes(searchKeyword)) ||
               (person.remark && person.remark.toLowerCase().includes(searchKeyword)) ||
               person.displayName.toLowerCase().includes(searchKeyword);
      });

      renderPersonList(filtered);
    }

    // æ˜¾ç¤ºæ–°å¢äººå‘˜è¡¨å•
    function showAddPersonForm() {
      document.getElementById('personFormTitle').textContent = 'æ–°å¢äººå‘˜';
      document.getElementById('personForm').reset();
      document.getElementById('personId').value = '';
      document.getElementById('personFormCard').style.display = 'block';
      // æ»šåŠ¨åˆ°è¡¨å•ä½ç½®
      document.getElementById('personFormCard').scrollIntoView({ behavior: 'smooth' });
    }

    // ç¼–è¾‘äººå‘˜
    function editPerson(id) {
      const person = personList.find(p => p.id === id);
      if (person) {
        document.getElementById('personFormTitle').textContent = 'ç¼–è¾‘äººå‘˜';
        document.getElementById('personId').value = person.id;
        document.getElementById('personName').value = person.name;
        document.getElementById('personPurpose').value = person.purpose;
        document.getElementById('personRemark').value = person.remark;
        document.getElementById('personFormCard').style.display = 'block';
        // æ»šåŠ¨åˆ°è¡¨å•ä½ç½®
        document.getElementById('personFormCard').scrollIntoView({ behavior: 'smooth' });
      }
    }

    // éšè—äººå‘˜è¡¨å•
    function hidePersonForm() {
      document.getElementById('personFormCard').style.display = 'none';
    }

    // ä¿å­˜äººå‘˜
    function savePerson(event) {
      event.preventDefault();
      
      const id = document.getElementById('personId').value;
      const name = document.getElementById('personName').value.trim();
      const purpose = document.getElementById('personPurpose').value.trim();
      const remark = document.getElementById('personRemark').value.trim();
      
      if (!name) {
        showToast("è¯·è¾“å…¥äººå‘˜å§“å", "error");
        return;
      }
      
      // ç”Ÿæˆæ˜¾ç¤ºå
      const displayName = purpose ? `${name}ï¼ˆ${purpose}ï¼‰` : name;
      
      showLoading("ä¿å­˜ä¸­...");
      
      setTimeout(() => { // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        if (id) {
          // æ›´æ–°ç°æœ‰äººå‘˜
          const index = personList.findIndex(p => p.id === parseInt(id));
          if (index !== -1) {
            const oldDisplayName = personList[index].displayName;
            personList[index] = {
              ...personList[index],
              name,
              purpose,
              remark,
              displayName
            };
            
            // å¦‚æœæ˜¾ç¤ºåå˜äº†ï¼Œæ›´æ–°ç›¸å…³å·ç çš„è¢«åˆ†é…äºº
            if (oldDisplayName !== displayName) {
              numberList.forEach(num => {
                if (num.assignee === oldDisplayName) {
                  num.assignee = displayName;
                  // æ·»åŠ æ—¥å¿—è®°å½•
                  addLog(num.id, 'äººå‘˜ä¿¡æ¯æ›´æ–°', `è¢«åˆ†é…äººåç§°ä» "${oldDisplayName}" å˜æ›´ä¸º "${displayName}"`, num.assignee ? 'used' : 'unused');
                }
              });
              saveNumbersToStorage();
            }
            
            showToast('äººå‘˜ä¿¡æ¯æ›´æ–°æˆåŠŸ', "success");
          }
        } else {
          // æ–°å¢äººå‘˜
          const newId = personList.length > 0 
            ? Math.max(...personList.map(p => p.id)) + 1 
            : 1;
            
          personList.push({
            id: newId,
            name,
            purpose,
            remark,
            displayName
          });
          
          showToast(`äººå‘˜ "${displayName}" æ–°å¢æˆåŠŸ`, "success");
        }
        
        // ä¿å­˜æ•°æ®å¹¶åˆ·æ–°åˆ—è¡¨
        savePersonsToStorage();
        renderPersonList();
        hidePersonForm();
        hideLoading();
      }, 500);
    }

    // åˆ é™¤äººå‘˜
    function deletePerson(id) {
      const person = personList.find(p => p.id === id);
      if (!person) return;
      
      // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”çš„å·ç 
      const relatedNumbers = numberList.filter(num => num.assignee === person.displayName).length;
      if (relatedNumbers > 0) {
        if (!confirm(`è¯¥äººå‘˜ "${person.displayName}" å…³è”äº† ${relatedNumbers} ä¸ªå·ç ï¼Œåˆ é™¤åè¿™äº›å·ç å°†å˜ä¸ºæœªåˆ†é…çŠ¶æ€ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
          return;
        }
      } else {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤äººå‘˜ "${person.displayName}" å—ï¼Ÿ`)) {
          return;
        }
      }
      
      showLoading("åˆ é™¤ä¸­...");
      
      setTimeout(() => { // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        const index = personList.findIndex(p => p.id === id);
        if (index !== -1) {
          // æ›´æ–°å…³è”å·ç 
          if (relatedNumbers > 0) {
            numberList.forEach(num => {
              if (num.assignee === person.displayName) {
                num.assignee = "";
                // æ·»åŠ æ—¥å¿—è®°å½•
                addLog(num.id, 'è§£é™¤åˆ†é…', `åŸè¢«åˆ†é…äºº "${person.displayName}" å·²åˆ é™¤ï¼Œè‡ªåŠ¨è§£é™¤åˆ†é…`, 'unused');
              }
            });
            saveNumbersToStorage();
          }
          
          // åˆ é™¤äººå‘˜
          personList.splice(index, 1);
          savePersonsToStorage();
          
          renderPersonList();
          renderNumberList(); // åˆ·æ–°å·ç åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ›´æ–°åçš„åˆ†é…çŠ¶æ€
          showToast(`äººå‘˜ "${person.displayName}" å·²åˆ é™¤`, "success");
        }
        hideLoading();
      }, 500);
    }

    // æç¤ºæ¡†å’ŒåŠ è½½åŠ¨ç”»æ§åˆ¶
    function showToast(message, type = "info") {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast'; // é‡ç½®æ ·å¼
      toast.classList.add('show', `toast-${type}`);
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function showLoading(text = "å¤„ç†ä¸­...") {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loading').classList.add('show');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
    }
  </script>
</body>
</html>
